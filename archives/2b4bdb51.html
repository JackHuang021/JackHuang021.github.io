<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"jackhuang021.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac","show_result":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="概述Linux内核中对GPIO资源进行了抽象，抽象为gpiolib，管理GPIO资源 gpiolib汇总了GPIO的通用操作，根据GPIO的特性，gpiolib对上（其他用到GPIO的driver）提供一套统一的操作GPIO的软件接口，屏蔽了不同芯片的具体实现；对下（specific chip driver）提供了针对不同芯片操作的一套框架，针对不同芯片，只需要实现这套框架，然后使用gpiolib">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux GPIO驱动框架">
<meta property="og:url" content="https://jackhuang021.github.io/archives/2b4bdb51.html">
<meta property="og:site_name" content="Jack&#39;s Home">
<meta property="og:description" content="概述Linux内核中对GPIO资源进行了抽象，抽象为gpiolib，管理GPIO资源 gpiolib汇总了GPIO的通用操作，根据GPIO的特性，gpiolib对上（其他用到GPIO的driver）提供一套统一的操作GPIO的软件接口，屏蔽了不同芯片的具体实现；对下（specific chip driver）提供了针对不同芯片操作的一套框架，针对不同芯片，只需要实现这套框架，然后使用gpiolib">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20230506100520.png">
<meta property="og:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20230506140748.png">
<meta property="article:published_time" content="2022-11-17T08:14:27.000Z">
<meta property="article:modified_time" content="2023-06-29T09:58:20.513Z">
<meta property="article:author" content="Jack">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="GPIO">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20230506100520.png">


<link rel="canonical" href="https://jackhuang021.github.io/archives/2b4bdb51.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jackhuang021.github.io/archives/2b4bdb51.html","path":"archives/2b4bdb51.html","title":"Linux GPIO驱动框架"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux GPIO驱动框架 | Jack's Home</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?cf1cdec429059a964c53024129e34116"></script>





  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Jack's Home</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gpiolib%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">gpiolib相关数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gpiolib%E5%AF%B9%E6%8E%A5%E8%8A%AF%E7%89%87%E5%BA%95%E5%B1%82"><span class="nav-number">3.</span> <span class="nav-text">gpiolib对接芯片底层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9GPIO%E4%B8%AD%E6%96%AD%E7%9A%84%E7%AE%A1%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">对GPIO中断的管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#phytium-gpio%E9%A9%B1%E5%8A%A8"><span class="nav-number">4.1.</span> <span class="nav-text">phytium gpio驱动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E4%B8%AD%E6%96%AD%E9%80%9A%E7%94%A8%E6%A1%86%E6%9E%B6"><span class="nav-number">5.</span> <span class="nav-text">Linux中断通用框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IRQ-domain"><span class="nav-number">5.1.</span> <span class="nav-text">IRQ domain</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8E%E4%B8%AD%E6%96%AD%E7%9B%B8%E5%85%B3%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">5.2.</span> <span class="nav-text">与中断相关的数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%8F%96%E5%BE%97linux-irq%E4%B8%AD%E6%96%AD%E5%8F%B7"><span class="nav-number">5.2.1.</span> <span class="nav-text">如何取得linux irq中断号</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jack"
      src="/images/favicon-32x32.png">
  <p class="site-author-name" itemprop="name">Jack</p>
  <div class="site-description" itemprop="description">build a better world</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/JackHuang021" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;JackHuang021" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jackhuang021@gmail.com" title="E-Mail → mailto:jackhuang021@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jackhuang021.github.io/archives/2b4bdb51.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon-32x32.png">
      <meta itemprop="name" content="Jack">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jack's Home">
      <meta itemprop="description" content="build a better world">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux GPIO驱动框架 | Jack's Home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux GPIO驱动框架
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-17 16:14:27" itemprop="dateCreated datePublished" datetime="2022-11-17T16:14:27+08:00">2022-11-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-06-29 17:58:20" itemprop="dateModified" datetime="2023-06-29T17:58:20+08:00">2023-06-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>24k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>22 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Linux内核中对GPIO资源进行了抽象，抽象为gpiolib，管理GPIO资源</p>
<p>gpiolib汇总了GPIO的通用操作，根据GPIO的特性，gpiolib对上（其他用到GPIO的driver）提供一套统一的操作GPIO的软件接口，屏蔽了不同芯片的具体实现；对下（specific chip driver）提供了针对不同芯片操作的一套框架，针对不同芯片，只需要实现这套框架，然后使用gpiolib提供的注册函数，将其挂接到gpiolib上，就完成了gpio驱动的编写</p>
<span id="more"></span>

<h3 id="gpiolib相关数据结构"><a href="#gpiolib相关数据结构" class="headerlink" title="gpiolib相关数据结构"></a>gpiolib相关数据结构</h3><p><code>struct gpio_chip</code>，这个结构是为了抽象GPIO的所有操作，这个结构是要开出去给其他芯片进行特定的操作赋值的，gpio_chip的抽象是针对GPIO一组bank的抽象，通常在硬件上，一个芯片的IO口，分为了很多个bank，每个bank分为了N组GPIO，可以理解为每一个bank有一组gpio操作的寄存器，可以通过这些寄存器对该bank的GPIO进行配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/gpio/driver.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_chip</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*label;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_device</span>	*<span class="title">gpiodev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		*<span class="title">parent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>		*<span class="title">owner</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			(*request)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> offset);</span><br><span class="line">	<span class="keyword">void</span>			(*<span class="built_in">free</span>)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> offset);</span><br><span class="line">	<span class="keyword">int</span>			(*get_direction)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> offset);</span><br><span class="line">	<span class="keyword">int</span>			(*direction_input)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> offset);</span><br><span class="line">	<span class="keyword">int</span>			(*direction_output)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> offset, <span class="keyword">int</span> value);</span><br><span class="line">	<span class="keyword">int</span>			(*get)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> offset);</span><br><span class="line">	<span class="keyword">int</span>			(*get_multiple)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> <span class="keyword">long</span> *mask,</span><br><span class="line">						<span class="keyword">unsigned</span> <span class="keyword">long</span> *bits);</span><br><span class="line">	<span class="keyword">void</span>			(*<span class="built_in">set</span>)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> offset, <span class="keyword">int</span> value);</span><br><span class="line">	<span class="keyword">void</span>			(*set_multiple)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> <span class="keyword">long</span> *mask,</span><br><span class="line">						<span class="keyword">unsigned</span> <span class="keyword">long</span> *bits);</span><br><span class="line">	<span class="keyword">int</span>			(*set_config)(struct gpio_chip *chip,</span><br><span class="line">					      <span class="keyword">unsigned</span> offset,</span><br><span class="line">					      <span class="keyword">unsigned</span> <span class="keyword">long</span> config);</span><br><span class="line">	<span class="keyword">int</span>			(*to_irq)(struct gpio_chip *chip,</span><br><span class="line">						<span class="keyword">unsigned</span> offset);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>			(*dbg_show)(struct seq_file *s,</span><br><span class="line">						struct gpio_chip *chip);</span><br><span class="line">	<span class="keyword">int</span>			base;</span><br><span class="line">	u16			ngpio;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*<span class="keyword">const</span> *names;</span><br><span class="line">	<span class="keyword">bool</span>			can_sleep;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_GPIO_GENERIC)</span></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">long</span> <span class="params">(*read_reg)</span><span class="params">(<span class="keyword">void</span> __iomem *reg)</span></span>;</span><br><span class="line">	<span class="keyword">void</span> (*write_reg)(<span class="keyword">void</span> __iomem *reg, <span class="keyword">unsigned</span> <span class="keyword">long</span> data);</span><br><span class="line">	<span class="keyword">bool</span> be_bits;</span><br><span class="line">	<span class="keyword">void</span> __iomem *reg_dat;</span><br><span class="line">	<span class="keyword">void</span> __iomem *reg_set;</span><br><span class="line">	<span class="keyword">void</span> __iomem *reg_clr;</span><br><span class="line">	<span class="keyword">void</span> __iomem *reg_dir;</span><br><span class="line">	<span class="keyword">bool</span> bgpio_dir_inverted;</span><br><span class="line">	<span class="keyword">int</span> bgpio_bits;</span><br><span class="line">	<span class="keyword">spinlock_t</span> bgpio_lock;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> bgpio_data;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> bgpio_dir;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GPIOLIB_IRQCHIP</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * With CONFIG_GPIOLIB_IRQCHIP we get an irqchip inside the gpiolib</span></span><br><span class="line"><span class="comment">	 * to handle IRQs for most practical cases.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @irq:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Integrates interrupt chip functionality with the GPIO chip. Can be</span></span><br><span class="line"><span class="comment">	 * used to handle IRQs for most practical cases.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_irq_chip</span> <span class="title">irq</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @need_valid_mask:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * If set core allocates @valid_mask with all bits set to one.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">bool</span> need_valid_mask;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @valid_mask:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * If not %NULL holds bitmask of GPIOs which are valid to be used</span></span><br><span class="line"><span class="comment">	 * from the chip.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *valid_mask;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_OF_GPIO)</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If CONFIG_OF is enabled, then all GPIO controllers described in the</span></span><br><span class="line"><span class="comment">	 * device tree automatically may have an OF translation</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @of_node:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Pointer to a device tree node representing this GPIO controller.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_node</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @of_gpio_n_cells:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Number of cells used to form the GPIO specifier.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> of_gpio_n_cells;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @of_xlate:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Callback to translate a device tree GPIO specifier into a chip-</span></span><br><span class="line"><span class="comment">	 * relative GPIO number and flags.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*of_xlate)(struct gpio_chip *gc,</span><br><span class="line">			<span class="keyword">const</span> struct of_phandle_args *gpiospec, u32 *flags);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct gpio_desc</code>结构体，每个GPIO由一个gpio_desc来描述，看起来<code>gpio_chip</code>和<code>gpio_desc</code>是包含关系，但是kernel中并没有直接将其两个结构联系上，而是通过另一个结构体将其联系在一起，这个结构就是<code>gpio_device</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_device</span>	*<span class="title">gdev</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flags;</span><br><span class="line"><span class="comment">/* flag symbols are bit numbers */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_REQUESTED	0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_IS_OUT	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_EXPORT	2	<span class="comment">/* protected by sysfs_lock */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_SYSFS	3	<span class="comment">/* exported via /sys/class/gpio/control */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_ACTIVE_LOW	6	<span class="comment">/* value has active low */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_OPEN_DRAIN	7	<span class="comment">/* Gpio is open drain type */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_OPEN_SOURCE 8	<span class="comment">/* Gpio is open source type */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_USED_AS_IRQ 9	<span class="comment">/* GPIO is connected to an IRQ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_IS_HOGGED	11	<span class="comment">/* GPIO is hogged */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_TRANSITORY 12	<span class="comment">/* GPIO may lose value in sleep or reset */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Connection label */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*label;</span><br><span class="line">	<span class="comment">/* Name of the GPIO */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*name;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>gdev指针指向了这个gpio_desc所属的gpio_device，flag代表了该GPIO的属性状态</p>
<p><code>struct gpio_device</code>结构，<code>gpio_device</code>是软件层面上对一个bank的GPIO进行管理的单元</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct gpio_device - internal state container for GPIO devices</span></span><br><span class="line"><span class="comment"> * @id: numerical ID number for the GPIO chip</span></span><br><span class="line"><span class="comment"> * @dev: the GPIO device struct</span></span><br><span class="line"><span class="comment"> * @chrdev: character device for the GPIO device</span></span><br><span class="line"><span class="comment"> * @mockdev: class device used by the deprecated sysfs interface (may be</span></span><br><span class="line"><span class="comment"> * NULL)</span></span><br><span class="line"><span class="comment"> * @owner: helps prevent removal of modules exporting active GPIOs</span></span><br><span class="line"><span class="comment"> * @chip: pointer to the corresponding gpiochip, holding static</span></span><br><span class="line"><span class="comment"> * data for this device</span></span><br><span class="line"><span class="comment"> * @descs: array of ngpio descriptors.</span></span><br><span class="line"><span class="comment"> * @ngpio: the number of GPIO lines on this GPIO device, equal to the size</span></span><br><span class="line"><span class="comment"> * of the @descs array.</span></span><br><span class="line"><span class="comment"> * @base: GPIO base in the DEPRECATED global Linux GPIO numberspace, assigned</span></span><br><span class="line"><span class="comment"> * at device creation time.</span></span><br><span class="line"><span class="comment"> * @label: a descriptive name for the GPIO device, such as the part number</span></span><br><span class="line"><span class="comment"> * or name of the IP component in a System on Chip.</span></span><br><span class="line"><span class="comment"> * @data: per-instance data assigned by the driver</span></span><br><span class="line"><span class="comment"> * @list: links gpio_device:s together for traversal</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This state container holds most of the runtime variable data</span></span><br><span class="line"><span class="comment"> * for a GPIO device and can hold references and live on after the</span></span><br><span class="line"><span class="comment"> * GPIO chip has been removed, if it is still being used from</span></span><br><span class="line"><span class="comment"> * userspace.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_device</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span>			id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>		<span class="title">chrdev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		*<span class="title">mockdev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>		*<span class="title">owner</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_chip</span>	*<span class="title">chip</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span>	*<span class="title">descs</span>;</span></span><br><span class="line">	<span class="keyword">int</span>			base;</span><br><span class="line">	u16			ngpio;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*label;</span><br><span class="line">	<span class="keyword">void</span>			*data;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>        <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PINCTRL</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If CONFIG_PINCTRL is enabled, then gpio controllers can optionally</span></span><br><span class="line"><span class="comment">	 * describe the actual pin range which they serve in an SoC. This</span></span><br><span class="line"><span class="comment">	 * information would be used by pinctrl subsystem to configure</span></span><br><span class="line"><span class="comment">	 * corresponding pins for gpio usage.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">pin_ranges</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>struct gpio_device</code>中包含了<code>struct gpio_chip</code>和<code>struct gpio_desc</code>，这个结构体贯穿了整个gpiolib，因为gpio_device是代表的一个bank，所以在kernel中，对gpio_device的组织是由一个gpio_device的链表构成的</p>
<h3 id="gpiolib对接芯片底层"><a href="#gpiolib对接芯片底层" class="headerlink" title="gpiolib对接芯片底层"></a>gpiolib对接芯片底层</h3><p>底层需要对接的是实现对gpio的一些通用操作，这里主要是实现<code>gpio_chip</code>这个结构体，然后通过调用<code>gpiochip_add_data()</code>这个接口注册GPIO资源，或者使用<code>devm_gpiochip_add_data()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/gpio/driver.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> gpiochip_add_data(chip, data) gpiochip_add_data_with_key(chip, data, NULL, NULL)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// drivers/gpio/gpiolib.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gpiochip_add_data_with_key</span><span class="params">(struct gpio_chip *chip, <span class="keyword">void</span> *data,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct lock_class_key *lock_key,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct lock_class_key *request_key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	flags;</span><br><span class="line">	<span class="keyword">int</span>		status = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span>	i;</span><br><span class="line">	<span class="keyword">int</span>		base = chip-&gt;base;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_device</span> *<span class="title">gdev</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * First: allocate and populate the internal stat container, and</span></span><br><span class="line"><span class="comment">	 * set up the struct device.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// 首先分配gpio_device结构体来管理gpio资源</span></span><br><span class="line">    <span class="comment">// 对gdev-&gt;chip进行赋值</span></span><br><span class="line">    <span class="comment">// 对chip-&gt;gpiodev进行赋值</span></span><br><span class="line">	gdev = kzalloc(<span class="keyword">sizeof</span>(*gdev), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!gdev)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	gdev-&gt;dev.bus = &amp;gpio_bus_type;</span><br><span class="line">	gdev-&gt;chip = chip;</span><br><span class="line">	chip-&gt;gpiodev = gdev;</span><br><span class="line">	<span class="keyword">if</span> (chip-&gt;parent) &#123;</span><br><span class="line">		gdev-&gt;dev.parent = chip-&gt;parent;</span><br><span class="line">		gdev-&gt;dev.of_node = chip-&gt;parent-&gt;of_node;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_OF_GPIO</span></span><br><span class="line">	<span class="comment">/* If the gpiochip has an assigned OF node this takes precedence */</span></span><br><span class="line">	<span class="keyword">if</span> (chip-&gt;of_node)</span><br><span class="line">		gdev-&gt;dev.of_node = chip-&gt;of_node;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		chip-&gt;of_node = gdev-&gt;dev.of_node;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	gdev-&gt;id = ida_simple_get(&amp;gpio_ida, <span class="number">0</span>, <span class="number">0</span>, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (gdev-&gt;id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		status = gdev-&gt;id;</span><br><span class="line">		<span class="keyword">goto</span> err_free_gdev;</span><br><span class="line">	&#125;</span><br><span class="line">	dev_set_name(&amp;gdev-&gt;dev, <span class="string">&quot;gpiochip%d&quot;</span>, gdev-&gt;id);</span><br><span class="line">	device_initialize(&amp;gdev-&gt;dev);</span><br><span class="line">	dev_set_drvdata(&amp;gdev-&gt;dev, gdev);</span><br><span class="line">	<span class="keyword">if</span> (chip-&gt;parent &amp;&amp; chip-&gt;parent-&gt;driver)</span><br><span class="line">		gdev-&gt;owner = chip-&gt;parent-&gt;driver-&gt;owner;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (chip-&gt;owner)</span><br><span class="line">		<span class="comment">/* <span class="doctag">TODO:</span> remove chip-&gt;owner */</span></span><br><span class="line">		gdev-&gt;owner = chip-&gt;owner;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		gdev-&gt;owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配ngpio个gpio_desc结构体</span></span><br><span class="line">	gdev-&gt;descs = kcalloc(chip-&gt;ngpio, <span class="keyword">sizeof</span>(gdev-&gt;descs[<span class="number">0</span>]), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!gdev-&gt;descs) &#123;</span><br><span class="line">		status = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err_free_ida;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (chip-&gt;ngpio == <span class="number">0</span>) &#123;</span><br><span class="line">		chip_err(chip, <span class="string">&quot;tried to insert a GPIO chip with zero lines\n&quot;</span>);</span><br><span class="line">		status = -EINVAL;</span><br><span class="line">		<span class="keyword">goto</span> err_free_descs;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (chip-&gt;ngpio &gt; FASTPATH_NGPIO)</span><br><span class="line">		chip_warn(chip, <span class="string">&quot;line cnt %u is greater than fast path cnt %u\n&quot;</span>,</span><br><span class="line">		chip-&gt;ngpio, FASTPATH_NGPIO);</span><br><span class="line"></span><br><span class="line">	gdev-&gt;label = kstrdup_const(chip-&gt;label ?: <span class="string">&quot;unknown&quot;</span>, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!gdev-&gt;label) &#123;</span><br><span class="line">		status = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err_free_descs;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gdev-&gt;ngpio = chip-&gt;ngpio;</span><br><span class="line">    <span class="comment">// 将GPIO驱动指针存放到gpio_device-&gt;data中</span></span><br><span class="line">	gdev-&gt;data = data;</span><br><span class="line"></span><br><span class="line">	spin_lock_irqsave(&amp;gpio_lock, flags);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">TODO:</span> this allocates a Linux GPIO number base in the global</span></span><br><span class="line"><span class="comment">	 * GPIO numberspace for this chip. In the long run we want to</span></span><br><span class="line"><span class="comment">	 * get *rid* of this numberspace and use only descriptors, but</span></span><br><span class="line"><span class="comment">	 * it may be a pipe dream. It will not happen before we get rid</span></span><br><span class="line"><span class="comment">	 * of the sysfs interface anyways.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// base代表每个bank的编号</span></span><br><span class="line">	<span class="keyword">if</span> (base &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		base = gpiochip_find_base(chip-&gt;ngpio);</span><br><span class="line">		<span class="keyword">if</span> (base &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			status = base;</span><br><span class="line">			spin_unlock_irqrestore(&amp;gpio_lock, flags);</span><br><span class="line">			<span class="keyword">goto</span> err_free_label;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">TODO:</span> it should not be necessary to reflect the assigned</span></span><br><span class="line"><span class="comment">		 * base outside of the GPIO subsystem. Go over drivers and</span></span><br><span class="line"><span class="comment">		 * see if anyone makes use of this, else drop this and assign</span></span><br><span class="line"><span class="comment">		 * a poison instead.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		chip-&gt;base = base;</span><br><span class="line">	&#125;</span><br><span class="line">	gdev-&gt;base = base;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将该gpio_device挂到gpio_devices链表中进行管理</span></span><br><span class="line">	status = gpiodev_add_to_list(gdev);</span><br><span class="line">	<span class="keyword">if</span> (status) &#123;</span><br><span class="line">		spin_unlock_irqrestore(&amp;gpio_lock, flags);</span><br><span class="line">		<span class="keyword">goto</span> err_free_label;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spin_unlock_irqrestore(&amp;gpio_lock, flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化该组bank中每个gpio的gpio_desc的信息</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; chip-&gt;ngpio; i++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">desc</span> =</span> &amp;gdev-&gt;descs[i];</span><br><span class="line"></span><br><span class="line">		desc-&gt;gdev = gdev;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* REVISIT: most hardware initializes GPIOs as inputs (often</span></span><br><span class="line"><span class="comment">		 * with pullups enabled) so power usage is minimized. Linux</span></span><br><span class="line"><span class="comment">		 * code should set the gpio direction first thing; but until</span></span><br><span class="line"><span class="comment">		 * it does, and in case chip-&gt;get_direction is not set, we may</span></span><br><span class="line"><span class="comment">		 * expose the wrong direction in sysfs.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		desc-&gt;flags = !chip-&gt;direction_input ? (<span class="number">1</span> &lt;&lt; FLAG_IS_OUT) : <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PINCTRL</span></span><br><span class="line">	INIT_LIST_HEAD(&amp;gdev-&gt;pin_ranges);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	status = gpiochip_set_desc_names(chip);</span><br><span class="line">	<span class="keyword">if</span> (status)</span><br><span class="line">		<span class="keyword">goto</span> err_remove_from_list;</span><br><span class="line"></span><br><span class="line">	status = gpiochip_irqchip_init_valid_mask(chip);</span><br><span class="line">	<span class="keyword">if</span> (status)</span><br><span class="line">		<span class="keyword">goto</span> err_remove_from_list;</span><br><span class="line"></span><br><span class="line">	status = gpiochip_init_valid_mask(chip);</span><br><span class="line">	<span class="keyword">if</span> (status)</span><br><span class="line">		<span class="keyword">goto</span> err_remove_irqchip_mask;</span><br><span class="line"></span><br><span class="line">	status = gpiochip_add_irqchip(chip, lock_key, request_key);</span><br><span class="line">	<span class="keyword">if</span> (status)</span><br><span class="line">		<span class="keyword">goto</span> err_remove_chip;</span><br><span class="line"></span><br><span class="line">	status = of_gpiochip_add(chip);</span><br><span class="line">	<span class="keyword">if</span> (status)</span><br><span class="line">		<span class="keyword">goto</span> err_remove_chip;</span><br><span class="line"></span><br><span class="line">	acpi_gpiochip_add(chip);</span><br><span class="line"></span><br><span class="line">	machine_gpiochip_add(chip);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * By first adding the chardev, and then adding the device,</span></span><br><span class="line"><span class="comment">	 * we get a device node entry in sysfs under</span></span><br><span class="line"><span class="comment">	 * /sys/bus/gpio/devices/gpiochipN/dev that can be used for</span></span><br><span class="line"><span class="comment">	 * coldplug of device nodes and other udev business.</span></span><br><span class="line"><span class="comment">	 * We can do this only if gpiolib has been initialized.</span></span><br><span class="line"><span class="comment">	 * Otherwise, defer until later.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (gpiolib_initialized) &#123;</span><br><span class="line">		status = gpiochip_setup_dev(gdev);</span><br><span class="line">		<span class="keyword">if</span> (status)</span><br><span class="line">			<span class="keyword">goto</span> err_remove_chip;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_remove_chip:</span><br><span class="line">	acpi_gpiochip_remove(chip);</span><br><span class="line">	gpiochip_free_hogs(chip);</span><br><span class="line">	of_gpiochip_remove(chip);</span><br><span class="line">	gpiochip_free_valid_mask(chip);</span><br><span class="line">err_remove_irqchip_mask:</span><br><span class="line">	gpiochip_irqchip_free_valid_mask(chip);</span><br><span class="line">err_remove_from_list:</span><br><span class="line">	spin_lock_irqsave(&amp;gpio_lock, flags);</span><br><span class="line">	list_del(&amp;gdev-&gt;<span class="built_in">list</span>);</span><br><span class="line">	spin_unlock_irqrestore(&amp;gpio_lock, flags);</span><br><span class="line">err_free_label:</span><br><span class="line">	kfree_const(gdev-&gt;label);</span><br><span class="line">err_free_descs:</span><br><span class="line">	kfree(gdev-&gt;descs);</span><br><span class="line">err_free_ida:</span><br><span class="line">	ida_simple_remove(&amp;gpio_ida, gdev-&gt;id);</span><br><span class="line">err_free_gdev:</span><br><span class="line">	<span class="comment">/* failures here can mean systems won&#x27;t boot... */</span></span><br><span class="line">	pr_err(<span class="string">&quot;%s: GPIOs %d..%d (%s) failed to register, %d\n&quot;</span>, __func__,</span><br><span class="line">	       gdev-&gt;base, gdev-&gt;base + gdev-&gt;ngpio - <span class="number">1</span>,</span><br><span class="line">	       chip-&gt;label ? : <span class="string">&quot;generic&quot;</span>, status);</span><br><span class="line">	kfree(gdev);</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(gpiochip_add_data_with_key);</span><br></pre></td></tr></table></figure>

<h3 id="对GPIO中断的管理"><a href="#对GPIO中断的管理" class="headerlink" title="对GPIO中断的管理"></a>对GPIO中断的管理</h3><p><code>struct gpio_irq_chip</code>结构体，GPIO中断控制器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/gpio/driver.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_irq_chip</span> &#123;</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @chip:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * GPIO IRQ chip implementation, provided by GPIO driver.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span> *<span class="title">chip</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @domain:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Interrupt translation domain; responsible for mapping between GPIO</span></span><br><span class="line"><span class="comment">	 * hwirq number and Linux IRQ number.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span> *<span class="title">domain</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @domain_ops:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Table of interrupt domain operations for this IRQ chip.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">irq_domain_ops</span> *<span class="title">domain_ops</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @handler:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The IRQ handler to use (often a predefined IRQ core function) for</span></span><br><span class="line"><span class="comment">	 * GPIO IRQs, provided by GPIO driver.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">irq_flow_handler_t</span> handler;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @default_type:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Default IRQ triggering type applied during GPIO driver</span></span><br><span class="line"><span class="comment">	 * initialization, provided by GPIO driver.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> default_type;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @lock_key:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Per GPIO IRQ chip lockdep classes.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> *<span class="title">lock_key</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> *<span class="title">request_key</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @parent_handler:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The interrupt handler for the GPIO chip&#x27;s parent interrupts, may be</span></span><br><span class="line"><span class="comment">	 * NULL if the parent interrupts are nested rather than cascaded.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">irq_flow_handler_t</span> parent_handler;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @parent_handler_data:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Data associated, and passed to, the handler for the parent</span></span><br><span class="line"><span class="comment">	 * interrupt.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> *parent_handler_data;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @num_parents:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The number of interrupt parents of a GPIO chip.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_parents;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @parent_irq:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * For use by gpiochip_set_cascaded_irqchip()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> parent_irq;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @parents:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * A list of interrupt parents of a GPIO chip. This is owned by the</span></span><br><span class="line"><span class="comment">	 * driver, so the core will only reference this list, not modify it.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *parents;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @map:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * A list of interrupt parents for each line of a GPIO chip.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *<span class="built_in">map</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @threaded:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * True if set the interrupt handling uses nested threads.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">bool</span> threaded;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @need_valid_mask:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * If set core allocates @valid_mask with all bits set to one.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">bool</span> need_valid_mask;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @valid_mask:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * If not %NULL holds bitmask of GPIOs which are valid to be included</span></span><br><span class="line"><span class="comment">	 * in IRQ domain of the chip.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *valid_mask;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @first:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Required for static IRQ allocation. If set, irq_domain_add_simple()</span></span><br><span class="line"><span class="comment">	 * will allocate and map all IRQs during initialization.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> first;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="phytium-gpio驱动"><a href="#phytium-gpio驱动" class="headerlink" title="phytium gpio驱动"></a>phytium gpio驱动</h4><p>phytium_gpio结构体定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">phytium_gpio</span> &#123;</span></span><br><span class="line">	<span class="keyword">raw_spinlock_t</span>		lock;</span><br><span class="line">	<span class="keyword">void</span> __iomem		*regs;</span><br><span class="line">	<span class="comment">// 用来表示一个gpio控制器</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_chip</span>	<span class="title">gc</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span>		<span class="title">irq_chip</span>;</span></span><br><span class="line">	<span class="comment">// 用来表示gpio个数</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		ngpio[<span class="number">2</span>];</span><br><span class="line">	<span class="comment">// gpio中断号数组</span></span><br><span class="line">	<span class="keyword">int</span>			irq[<span class="number">32</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM_SLEEP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">phytium_gpio_ctx</span>	<span class="title">ctx</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>例如Phytium E2000 CPU共6个GPIO控制器，每个控制器提供16个GPIO信号<br><img src="https://raw.githubusercontent.com/JackHuang021/images/master/20230506100520.png"></p>
<h3 id="Linux中断通用框架"><a href="#Linux中断通用框架" class="headerlink" title="Linux中断通用框架"></a>Linux中断通用框架</h3><p>在linux中引入了irq_domain的概念，一个中断控制器就是一个irq_domain，中断控制器出现级联的布局，利用树状的结构可以充分的利用irq数目，每一个irq_domain可以去管理自己interrupt的特性</p>
<h4 id="IRQ-domain"><a href="#IRQ-domain" class="headerlink" title="IRQ domain"></a>IRQ domain</h4><p><code>irq_domain</code>用于将硬件的中断号，转换为Linux系统中的中断号（virq）</p>
<ul>
<li>每个中断控制器都对应一个irq_domain</li>
<li>中断控制器驱动通过irq_domain_add()接口来创建irq_domain</li>
<li>irq_domain支持三种映射方式：linear map，tree map，no map<ul>
<li>linear map：线性映射，维护固定大小的表，索引是硬件中断号，如果硬件中断最大数量固定，数值不大，可以选择线性映射</li>
<li>tree map：硬件中断号可能很大，可以选择树映射</li>
<li>no map：硬件中断号直接就是linux的中断号</li>
</ul>
</li>
<li>各个控制器的硬件中断号可以一样，最终在Linux内核中映射的中断号是唯一的</li>
</ul>
<p>每一个中断控制器对应多个中断号，而硬件中断号在不同的中断控制器上是会重复编码的，因此linux kernel提供了一个虚拟中断号的概念</p>
<h4 id="与中断相关的数据结构"><a href="#与中断相关的数据结构" class="headerlink" title="与中断相关的数据结构"></a>与中断相关的数据结构</h4><p>在看硬件中断号映射到虚拟中断号之前，来看几个比较重要的数据结构</p>
<p><code>struct irq_chip</code>结构体描述中断控制器的底层操作函数集，这些函数集最终完成对控制器硬件的操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>	*<span class="title">parent_device</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>	*name;</span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">int</span>	<span class="params">(*irq_startup)</span><span class="params">(struct irq_data *data)</span></span>;</span><br><span class="line">	<span class="keyword">void</span>		(*irq_shutdown)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_enable)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_disable)(struct irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		(*irq_ack)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_mask)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_mask_ack)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_unmask)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_eoi)(struct irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>		(*irq_set_affinity)(struct irq_data *data, <span class="keyword">const</span> struct cpumask *dest, <span class="keyword">bool</span> force);</span><br><span class="line">	<span class="keyword">int</span>		(*irq_retrigger)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">int</span>		(*irq_set_type)(struct irq_data *data, <span class="keyword">unsigned</span> <span class="keyword">int</span> flow_type);</span><br><span class="line">	<span class="keyword">int</span>		(*irq_set_wake)(struct irq_data *data, <span class="keyword">unsigned</span> <span class="keyword">int</span> on);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		(*irq_bus_lock)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_bus_sync_unlock)(struct irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		(*irq_cpu_online)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_cpu_offline)(struct irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		(*irq_suspend)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_resume)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_pm_shutdown)(struct irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		(*irq_calc_mask)(struct irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		(*irq_print_chip)(struct irq_data *data, struct seq_file *p);</span><br><span class="line">	<span class="keyword">int</span>		(*irq_request_resources)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_release_resources)(struct irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		(*irq_compose_msi_msg)(struct irq_data *data, struct msi_msg *msg);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_write_msi_msg)(struct irq_data *data, struct msi_msg *msg);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>		(*irq_get_irqchip_state)(struct irq_data *data, <span class="keyword">enum</span> irqchip_irq_state which, <span class="keyword">bool</span> *state);</span><br><span class="line">	<span class="keyword">int</span>		(*irq_set_irqchip_state)(struct irq_data *data, <span class="keyword">enum</span> irqchip_irq_state which, <span class="keyword">bool</span> state);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>		(*irq_set_vcpu_affinity)(struct irq_data *data, <span class="keyword">void</span> *vcpu_info);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		(*ipi_send_single)(struct irq_data *data, <span class="keyword">unsigned</span> <span class="keyword">int</span> cpu);</span><br><span class="line">	<span class="keyword">void</span>		(*ipi_send_mask)(struct irq_data *data, <span class="keyword">const</span> struct cpumask *dest);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>		(*irq_nmi_setup)(struct irq_data *data);</span><br><span class="line">	<span class="keyword">void</span>		(*irq_nmi_teardown)(struct irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct irq_desc</code>描述一个外设的中断，称为中断描述符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_desc</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_common_data</span>	<span class="title">irq_common_data</span>;</span></span><br><span class="line">	<span class="comment">// 中断控制器的硬件数据</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_data</span>		<span class="title">irq_data</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> __percpu	*kstat_irqs;</span><br><span class="line">	<span class="comment">// 中断控制器驱动的处理函数</span></span><br><span class="line">	<span class="keyword">irq_flow_handler_t</span>	handle_irq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irqaction</span>	*<span class="title">action</span>;</span>	<span class="comment">/* IRQ action list */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		status_use_accessors;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		core_internal_state__do_not_mess_with_it;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		depth;		<span class="comment">/* nested irq disables */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		wake_depth;	<span class="comment">/* nested wake enables */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		tot_count;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		irq_count;	<span class="comment">/* For detecting broken IRQs */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		last_unhandled;	<span class="comment">/* Aging timer for unhandled count */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		irqs_unhandled;</span><br><span class="line">	<span class="keyword">atomic_t</span>		threads_handled;</span><br><span class="line">	<span class="keyword">int</span>			threads_handled_last;</span><br><span class="line">	<span class="keyword">raw_spinlock_t</span>		lock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cpumask</span>		*<span class="title">percpu_enabled</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cpumask</span>	*<span class="title">percpu_affinity</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cpumask</span>	*<span class="title">affinity_hint</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_affinity_notify</span> *<span class="title">affinity_notify</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_PENDING_IRQ</span></span><br><span class="line">	<span class="keyword">cpumask_var_t</span>		pending_mask;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		threads_oneshot;</span><br><span class="line">	<span class="keyword">atomic_t</span>		threads_active;</span><br><span class="line">	<span class="keyword">wait_queue_head_t</span>       wait_for_threads;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM_SLEEP</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_actions;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		no_suspend_depth;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		cond_suspend_depth;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		force_resume_depth;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PROC_FS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span>	*<span class="title">dir</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_IRQ_DEBUGFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span>		*<span class="title">debugfs_file</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*dev_name;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPARSE_IRQ</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span>		<span class="title">kobj</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">request_mutex</span>;</span></span><br><span class="line">	<span class="keyword">int</span>			parent_irq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>		*<span class="title">owner</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*name;</span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br></pre></td></tr></table></figure>

<p><code>struct irq_data</code>包含中断控制器的硬件数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_data</span> &#123;</span></span><br><span class="line">	u32			mask;</span><br><span class="line">	<span class="comment">// 虚拟中断号</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		irq;</span><br><span class="line">	<span class="comment">// 硬件中断号</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		hwirq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_common_data</span>	*<span class="title">common</span>;</span></span><br><span class="line">	<span class="comment">// 对应的irq_chip数据结构</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span>		*<span class="title">chip</span>;</span></span><br><span class="line">	<span class="comment">// 对应的irq_domain数据结构</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span>	*<span class="title">domain</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>	CONFIG_IRQ_DOMAIN_HIERARCHY</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_data</span>		*<span class="title">parent_data</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">void</span>			*chip_data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct irq_domain</code>与中断控制器对应，完成硬件中断hwirq到virq的映射</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span> &#123;</span></span><br><span class="line">	<span class="comment">// 用于将irq_domain链接到全局链表irq_domain_list中</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">link</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="comment">// irq_domain映射操作函数集</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">irq_domain_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="comment">// 在GIC中断控制器驱动中，指向了irq_dic_data</span></span><br><span class="line">	<span class="keyword">void</span> *host_data;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="comment">// 映射中断的个数</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mapcount;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Optional data */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span> *<span class="title">fwnode</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">irq_domain_bus_token</span> <span class="title">bus_token</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain_chip_generic</span> *<span class="title">gc</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>	CONFIG_IRQ_DOMAIN_HIERARCHY</span></span><br><span class="line">	<span class="comment">// 支持中断级联的话，指向父设备</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span> *<span class="title">parent</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_IRQ_DEBUGFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span>		*<span class="title">debugfs_file</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* reverse map data. The linear map gets appended to the irq_domain */</span></span><br><span class="line">	<span class="comment">// irq_domain支持中断数量的最大值</span></span><br><span class="line">	<span class="keyword">irq_hw_number_t</span> hwirq_max;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> revmap_direct_max_irq;</span><br><span class="line">	<span class="comment">// 线性映射的大小</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> revmap_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">radix_tree_root</span> <span class="title">revmap_tree</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">revmap_tree_mutex</span>;</span></span><br><span class="line">	<span class="comment">// 线性映射用到的查找表</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> linear_revmap[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct irq_domain</code>结构体，用于irq_domain映射操作的函数集</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_domain_ops</span> &#123;</span></span><br><span class="line">	<span class="comment">// 用于中断控制器和irq domain的匹配</span></span><br><span class="line">	<span class="keyword">int</span> (*match)(struct irq_domain *d, struct device_node *node,</span><br><span class="line">		     <span class="keyword">enum</span> irq_domain_bus_token bus_token);</span><br><span class="line">	<span class="keyword">int</span> (*select)(struct irq_domain *d, struct irq_fwspec *fwspec,</span><br><span class="line">		      <span class="keyword">enum</span> irq_domain_bus_token bus_token);</span><br><span class="line">	<span class="comment">// 用于硬件中断号和linux中断号的映射</span></span><br><span class="line">	<span class="keyword">int</span> (*<span class="built_in">map</span>)(struct irq_domain *d, <span class="keyword">unsigned</span> <span class="keyword">int</span> virq, <span class="keyword">irq_hw_number_t</span> hw);</span><br><span class="line">	<span class="keyword">void</span> (*unmap)(struct irq_domain *d, <span class="keyword">unsigned</span> <span class="keyword">int</span> virq);</span><br><span class="line">	<span class="keyword">int</span> (*xlate)(struct irq_domain *d, struct device_node *node,</span><br><span class="line">		     <span class="keyword">const</span> u32 *intspec, <span class="keyword">unsigned</span> <span class="keyword">int</span> intsize,</span><br><span class="line">		     <span class="keyword">unsigned</span> <span class="keyword">long</span> *out_hwirq, <span class="keyword">unsigned</span> <span class="keyword">int</span> *out_type);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>	CONFIG_IRQ_DOMAIN_HIERARCHY</span></span><br><span class="line">	<span class="comment">/* extended V2 interfaces to support hierarchy irq_domains */</span></span><br><span class="line">	<span class="keyword">int</span> (*alloc)(struct irq_domain *d, <span class="keyword">unsigned</span> <span class="keyword">int</span> virq,</span><br><span class="line">		     <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_irqs, <span class="keyword">void</span> *arg);</span><br><span class="line">	<span class="keyword">void</span> (*<span class="built_in">free</span>)(struct irq_domain *d, <span class="keyword">unsigned</span> <span class="keyword">int</span> virq,</span><br><span class="line">		     <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_irqs);</span><br><span class="line">	<span class="keyword">int</span> (*activate)(struct irq_domain *d, struct irq_data *irqd, <span class="keyword">bool</span> reserve);</span><br><span class="line">	<span class="keyword">void</span> (*deactivate)(struct irq_domain *d, struct irq_data *irq_data);</span><br><span class="line">	<span class="keyword">int</span> (*translate)(struct irq_domain *d, struct irq_fwspec *fwspec,</span><br><span class="line">			 <span class="keyword">unsigned</span> <span class="keyword">long</span> *out_hwirq, <span class="keyword">unsigned</span> <span class="keyword">int</span> *out_type);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_IRQ_DEBUGFS</span></span><br><span class="line">	<span class="keyword">void</span> (*debug_show)(struct seq_file *m, struct irq_domain *d,</span><br><span class="line">			   struct irq_data *irqd, <span class="keyword">int</span> ind);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct irqaction</code>用来存储设备驱动注册的中断处理函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irqaction</span> &#123;</span></span><br><span class="line">	<span class="comment">// 设备驱动里的中断处理函数</span></span><br><span class="line">	<span class="keyword">irq_handler_t</span>		handler;</span><br><span class="line">	<span class="comment">// 设备id</span></span><br><span class="line">	<span class="keyword">void</span>			*dev_id;</span><br><span class="line">	<span class="keyword">void</span> __percpu		*percpu_dev_id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irqaction</span>	*<span class="title">next</span>;</span></span><br><span class="line">	<span class="keyword">irq_handler_t</span>		thread_fn;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>	*<span class="title">thread</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irqaction</span>	*<span class="title">secondary</span>;</span></span><br><span class="line">	<span class="comment">// 中断号</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		irq;</span><br><span class="line">	<span class="comment">// 中断标志</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		thread_flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		thread_mask;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span>	*<span class="title">dir</span>;</span></span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br></pre></td></tr></table></figure>

<p>其核心是围绕着<code>struct irq_desc</code>来展开的<br><img src="https://raw.githubusercontent.com/JackHuang021/images/master/20230506140748.png"></p>
<p>中断的处理主要有以下几个功能模块</p>
<ul>
<li>硬件中断号到linux irq中断号的映射，并创建好irq_desc中断描述符</li>
<li>中断注册时，先获取设备的中断号，根据中断号找到对应的irq_desc，并将设备的中断处理函数添加到irq_desc</li>
<li>设备触发中断信号时，根据硬件中断号得到linux irq中断号，找到对应的irq_desc，最终调用到设备的中断处理函数</li>
</ul>
<h5 id="如何取得linux-irq中断号"><a href="#如何取得linux-irq中断号" class="headerlink" title="如何取得linux irq中断号"></a>如何取得linux irq中断号</h5><p>硬件设备的中断信息都在设备树中进行了描述，在系统启动过程中，这些信息都已经解析并加载到了内存中，驱动中通常会使用<code>platform_get_irq()</code>接口，去根据设备树的信息去创建映射关系，硬件中断号到linux irq中断号映射，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs console=ttyAMA1,115200 earlycon=pl011,0x28001000 root=/dev/sda rootwait rw;ext4load scsi 0:0 0x90100000 boot/d2000/d2000-devboard-dsk.dtb;ext4load scsi 0:0 0x90200000 boot/d2000/Image;booti 0x90200000 - 0x90100000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">108:          0          0  28036000.gpio   5 Edge      es8336_interrupt</span><br><span class="line"></span><br><span class="line">109:          0          0  28038000.gpio  11 Edge      gpiomon</span><br></pre></td></tr></table></figure>








    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Jack
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://jackhuang021.github.io/archives/2b4bdb51.html" title="Linux GPIO驱动框架">https://jackhuang021.github.io/archives/2b4bdb51.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/GPIO/" rel="tag"># GPIO</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/archives/d281c370.html" rel="prev" title="Linux字符设备驱动开发">
                  <i class="fa fa-chevron-left"></i> Linux字符设备驱动开发
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/archives/21d76c15.html" rel="next" title="git使用记录">
                  git使用记录 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:47</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/JackHuang021" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
