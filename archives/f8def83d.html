<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"jackhuang021.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac","show_result":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="背景为了降低设备多样性带来的Linux驱动开发的复杂度，以及设备热插拔处理，电源管理等，Linux内核提出了设备模型（Driver Model）的概念。设备模型将硬件设备归纳、分类，然后抽象出一套标准的数据结构和接口，驱动的开发，就简化为对内核所规定的数据结构的填充和实现 设备模型基本概念Linux设备模型组成硬件拓扑描述Linux设备模型中四个重要概念：Bus、Class、Device、Devi">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux设备模型">
<meta property="og:url" content="https://jackhuang021.github.io/archives/f8def83d.html">
<meta property="og:site_name" content="Jack&#39;s Home">
<meta property="og:description" content="背景为了降低设备多样性带来的Linux驱动开发的复杂度，以及设备热插拔处理，电源管理等，Linux内核提出了设备模型（Driver Model）的概念。设备模型将硬件设备归纳、分类，然后抽象出一套标准的数据结构和接口，驱动的开发，就简化为对内核所规定的数据结构的填充和实现 设备模型基本概念Linux设备模型组成硬件拓扑描述Linux设备模型中四个重要概念：Bus、Class、Device、Devi">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-11-17T08:11:42.088Z">
<meta property="article:modified_time" content="2023-03-01T03:02:33.657Z">
<meta property="article:author" content="Jack">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Platform">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://jackhuang021.github.io/archives/f8def83d.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jackhuang021.github.io/archives/f8def83d.html","path":"archives/f8def83d.html","title":"Linux设备模型"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux设备模型 | Jack's Home</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?cf1cdec429059a964c53024129e34116"></script>





  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Jack's Home</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">2.</span> <span class="nav-text">设备模型基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E7%BB%84%E6%88%90"><span class="nav-number">2.1.</span> <span class="nav-text">Linux设备模型组成</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3"><span class="nav-number">2.2.</span> <span class="nav-text">设备模型的核心思想</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KObject"><span class="nav-number">3.</span> <span class="nav-text">KObject</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#kobject%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">3.1.</span> <span class="nav-text">kobject使用流程</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Uevent"><span class="nav-number">4.</span> <span class="nav-text">Uevent</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Uevent%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-number">4.1.</span> <span class="nav-text">Uevent的功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Uevent%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.2.</span> <span class="nav-text">Uevent代码实现</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sysfs"><span class="nav-number">5.</span> <span class="nav-text">sysfs</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sysfs%E4%BB%8B%E7%BB%8D"><span class="nav-number">5.1.</span> <span class="nav-text">sysfs介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sysfs%E5%92%8Ckobject%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-number">5.2.</span> <span class="nav-text">sysfs和kobject的关系</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#attribute%E5%8A%9F%E8%83%BD"><span class="nav-number">5.3.</span> <span class="nav-text">attribute功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#attribute%E5%AE%9A%E4%B9%89"><span class="nav-number">5.4.</span> <span class="nav-text">attribute定义</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#device%E5%92%8Cdevice-driver"><span class="nav-number">6.</span> <span class="nav-text">device和device driver</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">6.1.</span> <span class="nav-text">关键数据结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E6%A1%86%E6%9E%B6%E4%B8%8B%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4"><span class="nav-number">6.2.</span> <span class="nav-text">设备模型框架下驱动开发的基本步骤</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Bus"><span class="nav-number">7.</span> <span class="nav-text">Bus</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#bus%E5%AE%9A%E4%B9%89"><span class="nav-number">7.1.</span> <span class="nav-text">bus定义</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Class"><span class="nav-number">8.</span> <span class="nav-text">Class</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jack"
      src="/images/favicon-32x32.png">
  <p class="site-author-name" itemprop="name">Jack</p>
  <div class="site-description" itemprop="description">build a better world</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/JackHuang021" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;JackHuang021" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jackhuang021@gmail.com" title="E-Mail → mailto:jackhuang021@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jackhuang021.github.io/archives/f8def83d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon-32x32.png">
      <meta itemprop="name" content="Jack">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jack's Home">
      <meta itemprop="description" content="build a better world">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux设备模型 | Jack's Home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux设备模型
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-17 16:11:42" itemprop="dateCreated datePublished" datetime="2022-11-17T16:11:42+08:00">2022-11-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-03-01 11:02:33" itemprop="dateModified" datetime="2023-03-01T11:02:33+08:00">2023-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>16k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>为了降低设备多样性带来的Linux驱动开发的复杂度，以及设备热插拔处理，电源管理等，Linux内核提出了设备模型（Driver Model）的概念。设备模型将硬件设备归纳、分类，然后抽象出一套标准的数据结构和接口，驱动的开发，就简化为对内核所规定的数据结构的填充和实现</p>
<h4 id="设备模型基本概念"><a href="#设备模型基本概念" class="headerlink" title="设备模型基本概念"></a>设备模型基本概念</h4><h5 id="Linux设备模型组成"><a href="#Linux设备模型组成" class="headerlink" title="Linux设备模型组成"></a>Linux设备模型组成</h5><p>硬件拓扑描述Linux设备模型中四个重要概念：Bus、Class、Device、Device Driver</p>
<ol>
<li>Bus：总线是CPU和一个或多个设备之间信息交互的通道，而为了方便设备模型的抽象，所有的设备都应连接到总线上</li>
<li>Class：在Linux设备模型中，Class的概念非常类似面向对象程序设计中的Class，它主要是集合具有相似功能或属性的设备，这样就可以抽象出一套可以在多个设备之间共用的数据结构和接口函数，因为从属于相同Class的设备和驱动程序就不需要重复定义这些公共资源，直接从Class中继承</li>
<li>Device：抽象系统中所有的硬件设备，描述它的名字、属性、从属的Bus、从属的Class</li>
<li>Device Driver：Linux设备模型用Driver抽象硬件设备的驱动程序，它包含设备初始化、电源管理相关的接口实现，Linux内核中的驱动开发，基本都围绕该抽象进行实现</li>
</ol>
<h5 id="设备模型的核心思想"><a href="#设备模型的核心思想" class="headerlink" title="设备模型的核心思想"></a>设备模型的核心思想</h5><p>Linux设备模型的核心思想</p>
<ol>
<li>用Device和Device Driver两个数据结构，分别从“有什么用”和“怎么用”两个角度描述硬件设备，统一了编写设备驱动的格式</li>
<li>通过<code>Bus-&gt;Device</code>类型的树状结构解决设备之间的依赖，启动某一个设备前，内核会检查该设备是否依赖其它设备或者总线，如果依赖，则检查所依赖的对象是否已经启动，如果没有，则会先启动它们，直到启动该设备的条件具备为止。而驱动开发人员需要做的，就是在编写设备驱动时，告知内核该设备的依赖关系即可</li>
<li>使用Class结构，在设备模型中引入面向对象的概念，这样可以最大限度地抽象共性，减少驱动开发过程中的重复劳动，降低工作量</li>
</ol>
<h4 id="KObject"><a href="#KObject" class="headerlink" title="KObject"></a>KObject</h4><p>Linux内核中有大量的驱动，而这些驱动往往具有类似的结构，根据面向对象的思想，可以将共同的部分提取为父类，这个父类就是<code>kobject</code>，<code>kobject</code>中包含了大量设备的必须信息，三大类设备驱动都需要包含这个<code>kobject</code>结构，从面向对象的思想来看，即继承自<code>kobject</code>，一个<code>kobject</code>对象往往就对应sysfs中的一个目录，<code>kobject</code>是组成设备模型的基本结构，<code>kobject</code>需要处理的基本任务如下：</p>
<ul>
<li>通过parent指针，可以将所有kobject以层次结构的形式组合起来</li>
<li>对象的引用计数，当一个内核对象被创建时，不知道该对象的存活时间，跟踪该对象的生命周期的一个方法就是使用引用计数，当内核中没有代码持有该对象的引用时，说明该对象可以被销毁了</li>
<li>和sysfs虚拟文件系统配合，将每一个kobject及其特性，以文件的形式开放到用户空间</li>
</ul>
<p><em>注1：在Linux中，kobject几乎不会单独存在，它的主要功能就是内嵌在一个大型的数据结构中，为这个数据结构提供一些底层的功能实现</em></p>
<p><em>注2：Linux driver开发者，很少会直接使用Kobject以及它提供的接口，而是使用构建在Kobject之上的设备模型接口</em></p>
<p>kobject, kset, ktype三者的概念</p>
<ul>
<li>kobject是基本数据类型，每个kobject都会在<code>/sys</code>文件系统中以目录的形式出现</li>
<li>ktype代表kobject的属性操作集合，</li>
<li>Kset是一个特殊的Kobject（因此它也会在<code>/sys</code>文件系统中以目录的形式出现），它用来集合相似的Kobject</li>
</ul>
<p><code>kobject</code>的结构体定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/kobject.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>		*name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">entry</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span>		*<span class="title">parent</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kset</span>		*<span class="title">kset</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kobj_type</span>	*<span class="title">ktype</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kernfs_node</span>	*<span class="title">sd</span>;</span> <span class="comment">/* sysfs directory entry */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span>		<span class="title">kref</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_KOBJECT_RELEASE</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span>	<span class="title">release</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> state_initialized:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> state_in_sysfs:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> state_add_uevent_sent:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> state_remove_uevent_sent:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> uevent_suppress:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>name: 表示<code>kobject</code>对象的名字，对应sysfs下的一个目录</li>
<li>entry: <code>list_head</code>链表，用来链接各个<code>kobject</code>对象</li>
<li>parent: 指向当前<code>kobject</code>父对象的指针</li>
<li>kset: 表示当前<code>kobject</code>所属的集合</li>
<li>ktype: 表示当前<code>kobject</code>的类型</li>
<li>sd: 在sysfs中的表示</li>
<li>kref: 为<code>kobject</code>的引用计数，当引用计数为0时，就回调<code>release</code>方法释放该对象</li>
<li>state_initialized: 初始化标志位，在对象初始化时被置位，表示对象是否被初始化</li>
<li>state_in_sysfs: 表示<code>kobject</code>在sysfs中的状态，在对应目录中被创建则为1，否则为0</li>
<li>state_add_uevent_sent: 添加设备的uevent事件是否被发送标志</li>
<li>state_remove_uevent_sent: 删除设备的uevent事件是否被发送标志</li>
<li>uevent_suppress：如果该字段为1，则表示忽略所有上报的uevent事件</li>
</ul>
<p><em>uevent提供了“用户空间通知”的功能实现，通过该功能，当内核中有kobject的增加、删除、修改等动作时，会通知用户空间</em></p>
<p>kset的结构体定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//include/linux/kobject.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kset</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> list_lock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kset_uevent_ops</span> *<span class="title">uevent_ops</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li>list, list_lock：用于保存该kset下所有的kobject链表</li>
<li>kobj，该kset自己的kobject（kset是一个特殊的kobject，也会在sysfs中以目录的形式体现）</li>
<li>uevent_ops：该kset的uevent操作函数集。当任何Kobject需要上报uevent时，都要调用它所从属的kset的uevent_ops，添加环境变量，或者过滤event（kset可以决定哪些event可以上报）。因此，如果一个kobject不属于任何kset时，是不允许发送uevent的</li>
</ul>
<p>ktype的结构体定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//include/linux/ktype.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobj_type</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> (*release)(struct kobject *kobj);</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sysfs_ops</span> *<span class="title">sysfs_ops</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span> **<span class="title">default_attrs</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">default_groups</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_ns_type_operations</span> *(*<span class="title">child_ns_type</span>)（<span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">kobj</span>）;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *(*<span class="keyword">namespace</span>)(struct kobject *kobj);</span><br><span class="line">    <span class="keyword">void</span> (*get_ownership)(struct kobject *kobj, <span class="keyword">kuid_t</span> *uid, <span class="keyword">kgid_t</span> *gid);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>release: 通过该回调函数，可以将包含该种类型kobject的数据结构的内存空间释放掉</li>
<li>sysfs_ops：该种类型的kobject的sysfs文件系统接口</li>
<li>default_attrs：该种类型的kobject的atrribute列表（所谓attribute，就是sysfs文件系统中的一个文件）。将会在Kobject添加到内核时，一并注册到sysfs中</li>
<li>child_ns_type, namespace：和文件系统（sysfs）的命名空间有关</li>
</ul>
<p>每一个内嵌kobject的数据结构，例如kset、device、device_driver等等，都要实现一个ktype，并定义其中的回调函数，sysfs的相关操作也一样，必须经过ktype的中转，因为sysfs看到的是kobject，而真正的文件操作的主体，是内嵌kobject的上层数据结构</p>
<h5 id="kobject使用流程"><a href="#kobject使用流程" class="headerlink" title="kobject使用流程"></a>kobject使用流程</h5><p>kobject在大多数情况下会嵌在其他数据结构中使用，使用流程如下：</p>
<ol>
<li>定义一个<code>struct kset</code>类型的指针，并在初始化时为它分配空间，添加到内核中</li>
<li>根据实际情况，定义自己所需的数据结构原型，该数据结构中包含有kobjet</li>
<li>定义一个适合自己的ktype，并实现其中回调函数</li>
<li>在需要用到包含kobject的数据结构中，动态分配该数据结构，并分配kobject空间，添加到内核中</li>
<li>每一次引用数据结构时，调用<code>kobject_get</code>接口增加引用计数；引用结束时，调用<code>kobject_put</code>接口，减少引用计数</li>
<li>当引用计数减少为0时，kobject模块调用ktype所提供的release接口，释放上层数据结构以及kobject的内存空间</li>
</ol>
<h4 id="Uevent"><a href="#Uevent" class="headerlink" title="Uevent"></a>Uevent</h4><h5 id="Uevent的功能"><a href="#Uevent的功能" class="headerlink" title="Uevent的功能"></a>Uevent的功能</h5><p>Uevent是kobject的一部分，用于在kobject状态发生改变时，例如增加、移除等，通知用户空间程序，用户空间程序收到这样的事件后，会做相应的处理</p>
<p>该机制通常是用来支持热拔插设备的，例如U盘插入后，USB相关的驱动软件会动态创建用于表示该U盘的device结构（相应的也包括其中的kobject），并告知用户空间程序，为该U盘动态的创建&#x2F;dev&#x2F;目录下的设备节点，更进一步，可以通知其它的应用程序，将该U盘设备mount到系统中，从而动态的支持该设备。</p>
<h5 id="Uevent代码实现"><a href="#Uevent代码实现" class="headerlink" title="Uevent代码实现"></a>Uevent代码实现</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/kobject.h</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">kobject_action</span> &#123;</span></span><br><span class="line">    KOBJ_ADD,</span><br><span class="line">    KOBJ_REMOVE,</span><br><span class="line">    KOBJ_CHANGE,</span><br><span class="line">    KOBJ_MOVE,</span><br><span class="line">    KOBJ_ONLINE,</span><br><span class="line">    KOBJ_OFFLINE,</span><br><span class="line">    KOBJ_BIND,</span><br><span class="line">    KOBJ_UNBIND,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>ADD&#x2F;REMOVE: kobject（或上层数据结构）的添加、移除事件</li>
<li>ONLINE&#x2F;OFFLINE： kobject（或上层数据结构）的上线、下线事件</li>
<li>CHANGE：Kobject（或上层数据结构）的状态或者内容发生改变</li>
<li>MOVE：Kobject（或上层数据结构）更改名称或者更改Parent（意味着在sysfs中更改了目录结构）</li>
<li>CHANGE：如果设备驱动需要上报的事件不再上面事件的范围内，或者是自定义的事件，可以使用该event，并携带相应的参数</li>
</ul>
<p>在利用kmod向用户空间上报event事件时，会直接执行用户空间的可执行文件，而在Linux系统，可执行文件的执行依赖于环境变量，因此<code>kobj_uevent_env</code>用于组织此次事件上报时的环境变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/kobject.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UEVENT_NUM_ENVP         64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UEVENT_BUFFER_SIZE      2048</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobj_uevent_env</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *argv[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">char</span> *envp[UEVENT_NUM_ENVP];</span><br><span class="line">    <span class="keyword">int</span> envp_idx;</span><br><span class="line">    <span class="keyword">char</span> buf[UEVENT_BUFFER_SIZE];</span><br><span class="line">    <span class="keyword">int</span> buflen;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>envp：指针数组，用于保存每个环境变量的地址，最多可支持的环境变量数量为UEVENT_NUM_ENVP</li>
<li>envp_idx：用于访问环境变量指针数组的index</li>
<li>buf：保存环境变量的buffer，最大为UEVENT_BUFFER_SIZE</li>
<li>buflen：访问buf的变量</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kset_uevent_ops</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> (* <span class="keyword">const</span> filter)(struct kset *kset, struct kobject *kobj);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *(* <span class="keyword">const</span> name)(struct kset *kset, struct kobject *kobj);</span><br><span class="line">    <span class="keyword">int</span> (* <span class="keyword">const</span> uevent)(struct kset *kset, struct kobject *kobj,</span><br><span class="line">                        struct kobj_uevent_env *env);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>kset_uevent_ops</code>是为kset定制的一个数据结构，里面包含filter和uevent两个回调函数，用处如下：</p>
<ul>
<li>filter：当任何kobject需要上报uevent时，它所属的kset可以通过该接口过滤，阻止不希望上报的event，从而达到从整体上管理的目的</li>
<li>name：该接口可以返回kset的名称，如果一个kset没有合法的名称，则其下的所有kobject将不允许上报uevent</li>
<li>uevent：当任何kobject需要上报uevent时，它所属的kset可以通过给接口统一为这些event添加环境变量，因为很多时候上报uevent时的环境变量都是相同的，因此可以由kset统一处理，就不需要让每个Kobject独自添加了</li>
</ul>
<h4 id="sysfs"><a href="#sysfs" class="headerlink" title="sysfs"></a>sysfs</h4><h5 id="sysfs介绍"><a href="#sysfs介绍" class="headerlink" title="sysfs介绍"></a>sysfs介绍</h5><p>sysfs是一个基于RAM的文件系统，他和kobject一起，可以将kernel的数据结构导出到用户空间，以文件目录结构的形式，提供对这些数据结构的访问支持</p>
<h5 id="sysfs和kobject的关系"><a href="#sysfs和kobject的关系" class="headerlink" title="sysfs和kobject的关系"></a>sysfs和kobject的关系</h5><p>每一个kobject都会对应sysfs中的一个目录，因此在将kobject添加到kernel时，<code>create_dir</code>接口会调用sysfs文件系统的创建目录接口，创建和kobject对应的目录</p>
<h5 id="attribute功能"><a href="#attribute功能" class="headerlink" title="attribute功能"></a>attribute功能</h5><p>attribute是对应kobject而言的，指的是kobject的属性，sysfs中的目录描述了kobject，而kobject是特定数据结构类型变量（如struct device）的体现，因此kobject的属性，就是这些变量的属性，它可以是任何东西，名称、内部变量、字符串等，而attribute在sysfs文件系统中是以文件的形式提供的</p>
<p>attribute就是内核空间和用户空间进行信息交互的一种方法，例如某个driver定义了一个变量，却希望用户空间程序可以修改这个变量，以控制driver的运行行为，那么就可以将该变量以sysfs attribute的形式开放出来</p>
<h5 id="attribute定义"><a href="#attribute定义" class="headerlink" title="attribute定义"></a>attribute定义</h5><p>Linux内核中，attribute分为普通的attribute和二进制attribute，定义如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/types.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">umode_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// include/linux/sysfs.h </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">attribute</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">umode_t</span> mode;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// include/linux/sysfs.h </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin_attribute</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span> <span class="title">attr</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">void</span>  *<span class="keyword">private</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> (*read)(struct file *, struct kobject *,</span><br><span class="line">                struct bin_attribute *, <span class="keyword">char</span> *, <span class="keyword">loff_t</span>, <span class="keyword">size_t</span>);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*write)(struct file *, struct kobject *,</span><br><span class="line">                struct bin_attribute );</span><br><span class="line">    <span class="keyword">int</span> (*mmap)(struct file *, struct kobject *, </span><br><span class="line">                struct bin_attribute *attr, struct vm_area_struct *vma);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>struct attribute</code>为普通的attribute，使用该attribute生成的sysfs文件，只能用字符串的形式读写，而<code>struct bin_attribute</code>在<code>struct attribute</code>的基础上增加了read、write等函数，因此它所生成的sysfs文件可以用任何方式读写</p>
<h4 id="device和device-driver"><a href="#device和device-driver" class="headerlink" title="device和device driver"></a>device和device driver</h4><h5 id="关键数据结构"><a href="#关键数据结构" class="headerlink" title="关键数据结构"></a>关键数据结构</h5><p>struct device数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		*<span class="title">parent</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_private</span>	*<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*init_name; <span class="comment">/* initial name of the device */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_type</span> *<span class="title">type</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span>	*<span class="title">bus</span>;</span>		<span class="comment">/* type of bus device is on */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> *<span class="title">driver</span>;</span>	<span class="comment">/* which driver has allocated this</span></span><br><span class="line"><span class="comment">					   device */</span></span><br><span class="line">	<span class="keyword">void</span>		*platform_data;	<span class="comment">/* Platform specific data, device</span></span><br><span class="line"><span class="comment">					   core doesn&#x27;t touch it */</span></span><br><span class="line">	<span class="keyword">void</span>		*driver_data;	<span class="comment">/* Driver data, set and get with</span></span><br><span class="line"><span class="comment">					   dev_set_drvdata/dev_get_drvdata */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PROVE_LOCKING</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">lockdep_mutex</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">mutex</span>;</span>	<span class="comment">/* mutex to synchronize calls to</span></span><br><span class="line"><span class="comment">					 * its driver.</span></span><br><span class="line"><span class="comment">					 */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dev_links_info</span>	<span class="title">links</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_info</span>	<span class="title">power</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_domain</span>	*<span class="title">pm_domain</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ENERGY_MODEL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">em_perf_domain</span>	*<span class="title">em_pd</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_MSI_IRQ_DOMAIN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span>	*<span class="title">msi_domain</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PINCTRL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dev_pin_info</span>	*<span class="title">pins</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_MSI_IRQ</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">msi_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DMA_OPS</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dma_map_ops</span> *<span class="title">dma_ops</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	u64		*dma_mask;	<span class="comment">/* dma mask (if dma&#x27;able device) */</span></span><br><span class="line">	u64		coherent_dma_mask;<span class="comment">/* Like dma_mask, but for</span></span><br><span class="line"><span class="comment">					     alloc_coherent mappings as</span></span><br><span class="line"><span class="comment">					     not all hardware supports</span></span><br><span class="line"><span class="comment">					     64 bit addresses for consistent</span></span><br><span class="line"><span class="comment">					     allocations such descriptors. */</span></span><br><span class="line">	u64		bus_dma_limit;	<span class="comment">/* upstream dma constraint */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bus_dma_region</span> *<span class="title">dma_range_map</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_dma_parameters</span> *<span class="title">dma_parms</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">dma_pools</span>;</span>	<span class="comment">/* dma pools (if dma&#x27;ble) */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DMA_DECLARE_COHERENT</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dma_coherent_mem</span>	*<span class="title">dma_mem</span>;</span> <span class="comment">/* internal for coherent mem</span></span><br><span class="line"><span class="comment">					     override */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DMA_CMA</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cma</span> *<span class="title">cma_area</span>;</span>		<span class="comment">/* contiguous memory area for dma</span></span><br><span class="line"><span class="comment">					   allocations */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* arch specific additions */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dev_archdata</span>	<span class="title">archdata</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span>	*<span class="title">of_node</span>;</span> <span class="comment">/* associated device tree node */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span>	*<span class="title">fwnode</span>;</span> <span class="comment">/* firmware device node */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="keyword">int</span>		numa_node;	<span class="comment">/* NUMA node this device is close to */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">dev_t</span>			devt;	<span class="comment">/* dev_t, creates the sysfs &quot;dev&quot; */</span></span><br><span class="line">	u32			id;	<span class="comment">/* device instance */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">spinlock_t</span>		devres_lock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">devres_head</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="keyword">class</span>		*<span class="keyword">class</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">groups</span>;</span>	<span class="comment">/* optional groups */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>	(*release)(struct device *dev);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iommu_group</span>	*<span class="title">iommu_group</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dev_iommu</span>	*<span class="title">iommu</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span>			offline_disabled:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">bool</span>			offline:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">bool</span>			of_node_reused:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">bool</span>			state_synced:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_DEVICE) || \</span></span><br><span class="line"><span class="meta">    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU) || \</span></span><br><span class="line"><span class="meta">    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU_ALL)</span></span><br><span class="line">	<span class="keyword">bool</span>			dma_coherent:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DMA_OPS_BYPASS</span></span><br><span class="line">	<span class="keyword">bool</span>			dma_ops_bypass : <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>parent: 该设备的父设备，一般是该设备所从属的bus controller等设备</li>
<li>p：一个用于struct device的私有数据结构指针，该指针中保存子设备链表，用于添加到bus&#x2F;driver&#x2F;parent等设备中的链表头等</li>
<li>kobj：该数据结构对应的kobject</li>
<li>init_name：设备名称，在设备模型中，名称是一个非常重要的变量，任何注册到内核中的设备，都必须有一个合法的名称，可以在初始化时给出，也可以由内核根据”bus_name + device id”的方式去创造</li>
<li>type：<code>struct device_type</code>它和<code>struct device</code>的关系非常类似<code>struct kobject</code>和<code>struct kobj_type</code>之间的关系</li>
<li>bus：该device属于哪个总线</li>
<li>driver：该device对应的device driver</li>
<li>platform_data：用于保存具体的平台相关的数据，可以将一些私有的数据暂存在这里，需要使用的时候，再拿出来</li>
<li>driver_data：用于保存和driver相关的私有数据</li>
<li>dev_t：一个32位的整数，由（major和minor）组成，以设备节点的形式向用户空间提供接口的设备中，当作设备号使用，该变量主要用于在sys文件系统中，为每个具有设备号的device，创建<code>/sys/dev/*</code>下的对应目录</li>
<li>class：该设备属于哪个class</li>
<li>group：该设备的默认attribute集合，将会在设备注册时自动在sysfs中创建对应的文件</li>
</ul>
<p>struct device_driver数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/device/driver.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> *<span class="title">bus</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mod_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> suppress_bind_attrs;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">probe_type</span> <span class="title">probe_type</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">of_match_table</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">acpi_device_id</span> *<span class="title">acpi_match_table</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*probe) (struct devcie *dev);</span><br><span class="line">    <span class="keyword">void</span> (*sync_state)(struct device *dev);</span><br><span class="line">    <span class="keyword">int</span> (*remove) (struct device *dev);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown) (struct device *dev);</span><br><span class="line">    <span class="keyword">int</span> (*suspend) (struct device *dev, <span class="keyword">pm_message_t</span> state);</span><br><span class="line">    <span class="keyword">int</span> (*resume) (struct device *dev);</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">groups</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">dev_groups</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span></span><br><span class="line">    <span class="keyword">void</span> (*coredump) (struct device *dev);</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">drvier_private</span> *<span class="title">p</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>name：driver名称，和device结构一样，名称非常重要</li>
<li>bus：该driver所驱动设备的bus，内核要保证在driver运行前，设备所依赖的总线正确初始化</li>
<li>owner, mod_name：内核module相关的变量</li>
<li>suppres_bind_attrs：是否在sysfs中启用bind和unbind attribute</li>
<li>probe, remove：这两个接口函数用于实现driver逻辑的开始和结束，在设备模型的结构下，只有driver和device同时存在时，才需要开始执行driver的代码逻辑。这也是probe和remove两个接口名称的由来：检测到了设备和移除了设备</li>
<li>shutdown、suspend、resume、pm：电源管理相关的内容</li>
<li>groups：和struct device结构中的同名变量类似，driver也可以定义一些默认attribute，这样在将driver注册到内核中时，内核设备模型部分的代码（driver&#x2F;base&#x2F;driver.c）会自动将这些attribute添加到sysfs中</li>
<li>p：driver的私有数据指针，其他模块不能访问</li>
</ul>
<h5 id="设备模型框架下驱动开发的基本步骤"><a href="#设备模型框架下驱动开发的基本步骤" class="headerlink" title="设备模型框架下驱动开发的基本步骤"></a>设备模型框架下驱动开发的基本步骤</h5><p>在设备模型框架下，设备驱动的开发主要包括2个步骤</p>
<ol>
<li>分配一个<code>struct device</code>类型的变量，填充必要的信息后，把它注册到内核中</li>
<li>分配一个<code>struct device_driver</code>类型的变量，填充必要的信息后，把它注册到内核中</li>
</ol>
<p>这两步完成后，内核会在合适的时机，调用<code>struct device_driver</code>变量中的probe, remove, suspend, resume等回调函数，从而触发或终结设备驱动的执行，所有的驱动程序逻辑都会由这些回调函数实现</p>
<p><em>一般情况下，Linux驱动开发很少直接使用device和device_driver，因为内核在它们之上又封装了一层，如platform_device等，这些层次提供的接口更为简单，易用</em></p>
<h4 id="Bus"><a href="#Bus" class="headerlink" title="Bus"></a>Bus</h4><p>在Linux设备模型中，Bus（总线）是一类特殊的设备，它是连接处理器和其它设备之间的通道（channel）。为了方便设备模型的实现，内核规定，系统中的每个设备都要连接在一个Bus上，这个Bus可以是一个内部Bus、虚拟Bus或者Platform Bus</p>
<h5 id="bus定义"><a href="#bus定义" class="headerlink" title="bus定义"></a>bus定义</h5><p>内核通过<code>struct bus_type</code>结构抽象bus</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/device/bus.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *dev_name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev_root</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">bus_groups</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">dev_groups</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">drv_groups</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*match)(struct device *dev, struct device_driver *drv);</span><br><span class="line">    <span class="keyword">int</span> (*uevent)(struct device *dev, struct kobj_uevent_env *env);</span><br><span class="line">    <span class="keyword">int</span> (*probe)(struct device *dev);</span><br><span class="line">    <span class="keyword">void</span> (*sync_state)(struct device *dev);</span><br><span class="line">    <span class="keyword">int</span> (*remove)(struct device *dev);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct device *dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*online)(struct device *dev);</span><br><span class="line">    <span class="keyword">int</span> (*offline)(struct device *dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*suspend)(struct device *dev, <span class="keyword">pm_message_t</span> state);</span><br><span class="line">    <span class="keyword">int</span> (*resume)(struct device *dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*num_vf)(struct device *dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*dma_configure)(struct device *dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iommu_ops</span> *<span class="title">iommu_ops</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">lock_key</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> need_parent_lock;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>name: 该bus的名称，会在sysfs中以目录的形式存在，platform bus在sysfs中表现为”&#x2F;sys&#x2F;bus&#x2F;platform”</li>
<li>dev_name: 该名称和<code>struct device</code>结构中的init_name有关，对有些设备而言（例如批量化的USB设备），设计者根本就懒得为它起名字的，而内核也支持这种懒惰，允许将设备的名字留空。这样当设备注册到内核后，设备模型的核心逻辑就会用”bus-&gt;dev_name+device ID”的形式，为这样的设备生成一个名称</li>
<li>dev_root：和sub system功能有关</li>
<li>bus_groups, dev_groups, drv_groups：一些默认的attribute组</li>
<li>match：一个由具体的bus driver实现的回调函数，当任何属于该bus的device或device_driver添加到内核时，内核都会调用该接口，如果新加的device或device_driver匹配上了自己的另一半的话，该接口返回非零值，此时bus模块的核心逻辑就会执行后续的处理</li>
<li>uevent：一个由具体的bus driver实现的回调函数，当任何属于该Bus的device，发生添加、移除或者其它动作时，bus模块的核心逻辑就会调用该接口，以便bus driver能够修改环境变量</li>
<li>probe, remove：这两个回调函数，和device_driver中的非常类似，如果probe指定的device的话，需要保证该device所在的bus是被初始化过、确保能正确工作的，这就需要在执行device_driver的probe前，先执行它的bus的probe</li>
<li>shutdown, suspend, resume：和probe, remove的原理类似，这些是电源管理相关的实现</li>
</ul>
<p>subsys_private定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kset</span> <span class="title">subsys</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kset</span> *<span class="title">devices_kset</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">interfaces</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kset</span> *<span class="title">drivers_kset</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">klist</span> <span class="title">klist_devices</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">klist</span> <span class="title">klist_drivers</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">blocking_notifier_head</span> <span class="title">bus_notifier</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> drivers_autoprobe:<span class="number">1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> *<span class="title">bus</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kset</span> <span class="title">glue_dirs</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>subsys, devices_kset, drivers_kset：subsys代表了本bus的kobject集合，它下面可以包含其它的kset或者其它的kobject，devices_kset和drivers_kset则是bus下面的两个kset（如&#x2F;sys&#x2F;bus&#x2F;spi&#x2F;devices和&#x2F;sys&#x2F;bus&#x2F;spi&#x2F;drivers），分别包括本bus下所有的device和device_driver</li>
<li>interfaces：一个list_head链表，用于保存该bus下所有的interface</li>
<li>klist_devices和klist_drivers：这两个链表分别保存了本bus下所有的device和device_driver指针，以方便查找</li>
<li>drivers_autoprobe：用于控制该bus下的drivers或者devices是否自动probe</li>
<li>bus, class：分别保存上层的bus和class指针</li>
</ul>
<h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><p>class是虚拟出来的，为了抽象设备的共性，class为一些相似的device提供通用的接口，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">class_groups</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">dev_groups</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">dev_kobj</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*dev_uevent)(struct device *dev, struct kobj_uevent_env *env);</span><br><span class="line">    <span class="keyword">char</span> *(*devnode)(struct device *dev, <span class="keyword">umode_t</span> *mode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*class_release)(struct class *class);</span><br><span class="line">    <span class="keyword">void</span> (*dev_release)(struct device *device);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*shutdown_pre)(struct device *dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_ns_type_operations</span> *<span class="title">ns_type</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *(*<span class="keyword">namespace</span>)(struct device *dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*get_ownership)(struct device *dev, <span class="keyword">kuid_t</span> *uid, <span class="keyword">kgid_t</span> *gid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> *<span class="title">p</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>name：class的名称，会在<code>/sys/class/</code>下体现</li>
<li>dev_kobj：表示该class下的设备在<code>/sys/dev/</code>下的目录</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="Jack 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="Jack 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>原作者： </strong>Jack
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://jackhuang021.github.io/archives/f8def83d.html" title="Linux设备模型">https://jackhuang021.github.io/archives/f8def83d.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/Platform/" rel="tag"># Platform</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/archives/4ed0329a.html" rel="prev" title="phytium E2000搭建aarch64虚拟机">
                  <i class="fa fa-chevron-left"></i> phytium E2000搭建aarch64虚拟机
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/archives/f8def83d.html" rel="next" title="Platform设备驱动模型">
                  Platform设备驱动模型 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:25</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/JackHuang021" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
