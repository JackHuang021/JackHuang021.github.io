<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"jackhuang021.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac","show_result":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="概述ALSA是Advanced Linux Sound Architecture的缩写，ALSA官网地址">
<meta property="og:type" content="article">
<meta property="og:title" content="ASoC Platform Driver">
<meta property="og:url" content="https://jackhuang021.github.io/archives/131a876a.html">
<meta property="og:site_name" content="Jack&#39;s Home">
<meta property="og:description" content="概述ALSA是Advanced Linux Sound Architecture的缩写，ALSA官网地址">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20221108112754.png">
<meta property="og:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20240124105117.png">
<meta property="og:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20240124105147.png">
<meta property="og:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20240410140458.png">
<meta property="og:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20240409143156.png">
<meta property="og:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20240410153336.png">
<meta property="og:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20240410171031.png">
<meta property="article:published_time" content="2022-10-26T05:42:24.000Z">
<meta property="article:modified_time" content="2024-04-12T09:55:16.336Z">
<meta property="article:author" content="Jack">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="ASoC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/JackHuang021/images/master/20221108112754.png">


<link rel="canonical" href="https://jackhuang021.github.io/archives/131a876a.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jackhuang021.github.io/archives/131a876a.html","path":"archives/131a876a.html","title":"ASoC Platform Driver"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ASoC Platform Driver | Jack's Home</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?cf1cdec429059a964c53024129e34116"></script>





  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Jack's Home</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ASoC%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6"><span class="nav-number">2.</span> <span class="nav-text">ASoC驱动框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%90%8D%E8%AF%8D%E6%8F%8F%E8%BF%B0"><span class="nav-number">3.</span> <span class="nav-text">相关名词描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Control%E8%AE%BE%E5%A4%87%E5%92%8Ckcontrol"><span class="nav-number">4.</span> <span class="nav-text">Control设备和kcontrol</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Control%E8%AE%BE%E5%A4%87"><span class="nav-number">4.1.</span> <span class="nav-text">Control设备</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Control%E8%AE%BE%E5%A4%87%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">4.1.1.</span> <span class="nav-text">Control设备的创建</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kcontrol"><span class="nav-number">4.2.</span> <span class="nav-text">kcontrol</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#kcontrol%E7%9B%B8%E5%85%B3%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">4.2.1.</span> <span class="nav-text">kcontrol相关的数据结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kcontrol%E7%9A%84%E8%BE%85%E5%8A%A9%E5%AE%8F"><span class="nav-number">4.2.2.</span> <span class="nav-text">kcontrol的辅助宏</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kcontrol%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="nav-number">4.2.3.</span> <span class="nav-text">kcontrol创建过程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#es8336-kcontrol%E5%AE%9A%E4%B9%89%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.2.4.</span> <span class="nav-text">es8336 kcontrol定义示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%B1%82%E8%AE%BF%E9%97%AEControl%E8%AE%BE%E5%A4%87"><span class="nav-number">4.2.5.</span> <span class="nav-text">应用层访问Control设备</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PCM%E8%AE%BE%E5%A4%87"><span class="nav-number">5.</span> <span class="nav-text">PCM设备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ALSA%E4%B8%ADpcm%E7%9B%B8%E5%85%B3%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">5.1.</span> <span class="nav-text">ALSA中pcm相关的数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ASoC%E4%B8%ADpcm%E7%9B%B8%E5%85%B3%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">5.2.</span> <span class="nav-text">ASoC中pcm相关的数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PCM%E8%AE%BE%E5%A4%87%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="nav-number">5.3.</span> <span class="nav-text">PCM设备创建过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DAPM%E7%9B%B8%E5%85%B3"><span class="nav-number">6.</span> <span class="nav-text">DAPM相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Widget%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.1.</span> <span class="nav-text">Widget介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">6.1.1.</span> <span class="nav-text">相关数据结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BE%85%E5%8A%A9%E5%AE%8F%E5%AE%9A%E4%B9%89widget"><span class="nav-number">6.1.2.</span> <span class="nav-text">辅助宏定义widget</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BE%85%E5%8A%A9%E5%AE%8F%E5%AE%9A%E4%B9%89dapm-kcontrol"><span class="nav-number">6.1.3.</span> <span class="nav-text">辅助宏定义dapm kcontrol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Path%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.2.</span> <span class="nav-text">Path介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#complete-path"><span class="nav-number">6.2.1.</span> <span class="nav-text">complete path</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Route%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.3.</span> <span class="nav-text">Route介绍</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#machine%E9%A9%B1%E5%8A%A8-%E4%BB%A5Phytium-DP%E9%9F%B3%E9%A2%91%E4%B8%BA%E4%BE%8B"><span class="nav-number">7.</span> <span class="nav-text">machine驱动 以Phytium DP音频为例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#machine%E9%A9%B1%E5%8A%A8-%E4%BB%A5asoc-simple-card%E4%B8%BA%E4%BE%8B"><span class="nav-number">8.</span> <span class="nav-text">machine驱动 以asoc-simple-card为例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">8.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#asoc-simple-card%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8A%82%E7%82%B9%E6%8F%8F%E8%BF%B0"><span class="nav-number">8.2.</span> <span class="nav-text">asoc-simple-card设备树节点描述</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#plarform%E9%A9%B1%E5%8A%A8-%E4%BB%A5phytium-i2s%E9%A9%B1%E5%8A%A8%E4%B8%BA%E4%BE%8B"><span class="nav-number">9.</span> <span class="nav-text">plarform驱动 以phytium i2s驱动为例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">9.1.</span> <span class="nav-text">相关结构体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#platform-driver%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="nav-number">9.2.</span> <span class="nav-text">platform driver注册过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#codec%E9%A9%B1%E5%8A%A8-%E4%BB%A5es8336%E4%B8%BA%E4%BE%8B"><span class="nav-number">10.</span> <span class="nav-text">codec驱动 以es8336为例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1"><span class="nav-number">10.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#component%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="nav-number">10.2.</span> <span class="nav-text">component注册过程</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jack"
      src="/images/favicon-32x32.png">
  <p class="site-author-name" itemprop="name">Jack</p>
  <div class="site-description" itemprop="description">build a better world</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/JackHuang021" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;JackHuang021" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jackhuang021@gmail.com" title="E-Mail → mailto:jackhuang021@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jackhuang021.github.io/archives/131a876a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon-32x32.png">
      <meta itemprop="name" content="Jack">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jack's Home">
      <meta itemprop="description" content="build a better world">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ASoC Platform Driver | Jack's Home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ASoC Platform Driver
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-26 13:42:24" itemprop="dateCreated datePublished" datetime="2022-10-26T13:42:24+08:00">2022-10-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-04-12 17:55:16" itemprop="dateModified" datetime="2024-04-12T17:55:16+08:00">2024-04-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>59k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>54 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>ALSA是Advanced Linux Sound Architecture的缩写，<a target="_blank" rel="noopener" href="https://www.alsa-project.org/">ALSA官网地址</a></p>
<span id="more"></span>

<p>ALSA作为Linux现在主流的音频体系架构，提供了内核的驱动框架，也提供了应用层的<br><code>alsa-lib</code>库，ALSA还提供了<code>alsa-utils</code>应用程序，方便进行音频控制</p>
<p>音频设备文件结构如下</p>
<p><img src="https://raw.githubusercontent.com/JackHuang021/images/master/20221108112754.png"></p>
<ul>
<li>controlC0: 用于card0声卡的控制</li>
<li>pcmC0D0c: 用于card0 device0录音的pcm设备</li>
<li>pcmC0D0p: 用于card0 device0播放的pcm设备</li>
<li>timer: 定时器</li>
</ul>
<p><img src="https://raw.githubusercontent.com/JackHuang021/images/master/20240124105117.png"></p>
<h3 id="ASoC驱动框架"><a href="#ASoC驱动框架" class="headerlink" title="ASoC驱动框架"></a>ASoC驱动框架</h3><p>ASoC（ALSA system on chip）是建立在标准ALSA驱动层上，对底层的ALSA框架封装了一层，为了更好的支持嵌入式CPU和音频编解码设备的一套软件体系，ASoC驱动主要由platform驱动、codec驱动、machine驱动组成。</p>
<p>machine驱动：充当描述和绑定其他组件驱动程序以形成ALSA声卡的粘合剂，machine可以理解为对声卡的抽象，它把cpu_dai，codec_dai通过dai_link链接起来，然后注册snd_soc_card。该驱动实现<code>struct snd_soc_card</code>的定义和注册，并通过指定<code>struct snd_soc_dai_link</code>中的<code>codec_name</code>, <code>platform_name</code>, <code>codec_dai_name</code>, <code>platform_dai_name</code>从而实现与其他各个驱动组件的绑定</p>
<p>platform驱动：一般指某一个SoC平台，与音频相关的通常包括SoC中的时钟、DMA、I2S、I2C等，我们可以认为他们组成了一个对应的音频platform，这个Platform只与SoC有关，这样我们可以把Platform抽象出来</p>
<p>codec驱动：codec字面上的意思就是编解码器，codec和platform一样，可以被多个machine使用，嵌入式codec一般通过I2C或SPI对内部的寄存器进行控制</p>
<p><img src="https://raw.githubusercontent.com/JackHuang021/images/master/20240124105147.png"></p>
<h3 id="相关名词描述"><a href="#相关名词描述" class="headerlink" title="相关名词描述"></a>相关名词描述</h3><p>DAPM（Dynamic Audio Power Management）：动态音频电源管理，用于Linux设备使用音频子系统内的最低电量，它独立于其他内核PM，DAPM对所有的用户空间应用程序来说也是完全透明的，因为所有电源切换都是在ASoC核心内完成的，对于用户空间应用程序，不需要更改代码，DAPM根据当前激活的音频流和声卡中的Mixer等的配置来决定哪些音频控件的电源开关打开或关闭</p>
<p>DAI(Digital Audio Interface)数字音频接口：数字音频接口全部是硬件接口，即同一个主板上IC芯片和IC芯片之间的通讯协议，数字音频接口有PCM、I2S、AC97、PDM</p>
<p>PCM编码（Pulse Code Modulation）：通过等时间间隔（即采样率时钟周期）采样将模拟信号转化为数字信号的方法，PCM使用等间隔采样方法，将每次采样的模拟分量幅度表示为N位的数字分量，因此PCM方式每次采样的结果都是N bit长的数据</p>
<p>Kcontrols：代表声卡里面的各种硬件开关，滑动控件等，通过软件定义kcontrol可以通过用户态配置硬件寄存器的开关，ALSA用snd_kcontrol_new定义kcontrol</p>
<p>Widget：具备路径和电源管理的kcontrol</p>
<p>Mixer：多个输入混合成一个输出，可以使用SND_SOC_DAPM_MIXER来定义这种类型的widget，mixer的widget类型为snd_soc_dapm_mixer</p>
<p>Mux：多路选择器，多路输入，但是只能选择一路作为输出，可以使用SND_SOC_DAPM_MUX来定义这个widget，widget类型为snd_soc_dapm_mux</p>
<p>pga：单路输入，单路输出，带gain调整的部件，可以使用SND_SOC_DAPM_PGA来定义这个widget，所属widget类型为snd_soc_dapm_pga</p>
<p>Path：path相当于电路中的一条跳线，它把一个widget的输出端和另一个widget的输入端连接在一起</p>
<p>Route：route用来描述一条完整的路径，它包括 起始端widget -&gt; path的输入 -&gt; path的输出 -&gt; 目标端widget，DAPM使用<code>struct snd_soc_dapm_route</code>结构来描述这样一个完整路径</p>
<h3 id="Control设备和kcontrol"><a href="#Control设备和kcontrol" class="headerlink" title="Control设备和kcontrol"></a>Control设备和kcontrol</h3><h4 id="Control设备"><a href="#Control设备" class="headerlink" title="Control设备"></a>Control设备</h4><p>Control是音频驱动中用来表示用户可操作的音频参数或功能的抽象设备，它可以是音量控制、Mixer（混音控制）、Mux（开关控制）等，Control提供了一个统一的接口，用于能够通过音频设备驱动程序来管理和调整音频参数，ALSA core层已经实现了Control中间层，在<code>include\sound\control.h</code>中定义了所有的Control API</p>
<h5 id="Control设备的创建"><a href="#Control设备的创建" class="headerlink" title="Control设备的创建"></a>Control设备的创建</h5><p>Control设备和PCM设备一样，都属于声卡下的逻辑设备。用户空间的应用程序通过alsa-lib访问该Control设备，读取或控制控件的控制状态，从而达到控制音频Codec进行各种Mixer等控制操作。</p>
<p>在声卡的初始化过程中会调用到<code>snd_ctrl_create()</code>来初始化Control设备，具体的流程如下：</p>
<p><img src="https://raw.githubusercontent.com/JackHuang021/images/master/20240410140458.png"></p>
<h4 id="kcontrol"><a href="#kcontrol" class="headerlink" title="kcontrol"></a>kcontrol</h4><p>kcontrol是一种控件，也可以理解为switch，主要实现控制声卡的音量、混音等一系列控制</p>
<p>kcontrol对应的数据结构是<code>struct snd_kcontrol_new</code>和<code>struct kcontrol</code>，kcontol的创建步骤如下：</p>
<ul>
<li>在codec驱动中定义<code>struct snd_kcontrol_new</code>数组</li>
<li>在声卡初始化的阶段，通过<code>snd_soc_component_controls()</code>创建并添加多个kcontrol到<code>struct snd_card</code>的controls链表中</li>
</ul>
<h5 id="kcontrol相关的数据结构"><a href="#kcontrol相关的数据结构" class="headerlink" title="kcontrol相关的数据结构"></a>kcontrol相关的数据结构</h5><p><code>struct snd_kcontrol_new</code>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/control.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> &#123;</span></span><br><span class="line">	<span class="keyword">snd_ctl_elem_iface_t</span> iface;	<span class="comment">/* interface identifier */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> device;		<span class="comment">/* device/client number */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> subdevice;		<span class="comment">/* subdevice (substream) number */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;		<span class="comment">/* ASCII name of item */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> index;		<span class="comment">/* index of item */</span></span><br><span class="line">	<span class="comment">/* 控件的访问类型 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> access;		<span class="comment">/* access rights */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> count;		<span class="comment">/* count of same elements */</span></span><br><span class="line">	<span class="comment">/* info回调函数用于获取控件的详细信息 */</span></span><br><span class="line">	<span class="keyword">snd_kcontrol_info_t</span> *info;</span><br><span class="line">	<span class="comment">/* get回调函数用于读取控件的当前值 */</span></span><br><span class="line">	<span class="keyword">snd_kcontrol_get_t</span> *get;</span><br><span class="line">	<span class="comment">/* put回调函数用于把应用程序的控制值设置到控件中 */</span></span><br><span class="line">	<span class="keyword">snd_kcontrol_put_t</span> *put;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">snd_kcontrol_tlv_rw_t</span> *c;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *p;</span><br><span class="line">	&#125; tlv;</span><br><span class="line">	<span class="comment">/* 存储了struct soc_mixer_control的信息 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> private_value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通常可以分成3部分来定义控件的名字：源——方向——功能，kernel文档中关于kcontrol命名<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v6.3/sound/designs/control-names.html">https://www.kernel.org/doc/html/v6.3/sound/designs/control-names.html</a></p>
<h5 id="kcontrol的辅助宏"><a href="#kcontrol的辅助宏" class="headerlink" title="kcontrol的辅助宏"></a>kcontrol的辅助宏</h5><p><code>SOC_SINGLE</code>宏，这种控件只一个控制量，比如一个开关</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * xname: 控件的名字</span></span><br><span class="line"><span class="comment"> * reg: 控件对应寄存器的地址</span></span><br><span class="line"><span class="comment"> * shift: 控件在寄存器中的偏移</span></span><br><span class="line"><span class="comment"> * max: 控件可设置的最大值</span></span><br><span class="line"><span class="comment"> * invert: 设定值是否逻辑取反</span></span><br><span class="line"><span class="comment"> * private_value: </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE(xname, reg, shift, max, invert) \</span></span><br><span class="line"><span class="meta">&#123;	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span></span><br><span class="line"><span class="meta">	.info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\</span></span><br><span class="line"><span class="meta">	.put = snd_soc_put_volsw, \</span></span><br><span class="line"><span class="meta">	.private_value = SOC_SINGLE_VALUE(reg, shift, max, invert, 0) &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE_VALUE(xreg, xshift, xmax, xinvert, xautodisable) \</span></span><br><span class="line"><span class="meta">	SOC_DOUBLE_VALUE(xreg, xshift, xshift, xmax, xinvert, xautodisable)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_DOUBLE_VALUE(xreg, shift_left, shift_right, xmax, xinvert, xautodisable) \</span></span><br><span class="line"><span class="meta">	((unsigned long)&amp;(struct soc_mixer_control) \</span></span><br><span class="line"><span class="meta">	&#123;.reg = xreg, .rreg = xreg, .shift = shift_left, \</span></span><br><span class="line"><span class="meta">	.rshift = shift_right, .max = xmax, .platform_max = xmax, \</span></span><br><span class="line"><span class="meta">	.invert = xinvert, .autodisable = xautodisable&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用soc_mixer_control来描述该控件对应寄存器控制的详细信息 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">soc_mixer_control</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> min, max, platform_max;</span><br><span class="line">	<span class="keyword">int</span> reg, rreg;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> shift, rshift;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> sign_bit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> invert:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> autodisable:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SND_SOC_TOPOLOGY</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dobj</span> <span class="title">dobj</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>SOC_SINGLE_TLV</code>宏，主要定义那些有增益控制的控件，例如音量控制器，EQ均衡器等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE_TLV(xname, reg, shift, max, invert, tlv_array) \</span></span><br><span class="line"><span class="meta">&#123;	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span></span><br><span class="line"><span class="meta">	.access = SNDRV_CTL_ELEM_ACCESS_TLV_READ |\</span></span><br><span class="line"><span class="meta">		 SNDRV_CTL_ELEM_ACCESS_READWRITE,\</span></span><br><span class="line"><span class="meta">	.tlv.p = (tlv_array), \</span></span><br><span class="line"><span class="meta">	.info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\</span></span><br><span class="line"><span class="meta">	.put = snd_soc_put_volsw, \</span></span><br><span class="line"><span class="meta">	.private_value = SOC_SINGLE_VALUE(reg, shift, max, invert, 0) &#125;</span></span><br></pre></td></tr></table></figure>

<p><code>SOC_DOUBLE</code>宏，可以在同一个寄存器中控制两个相似的变量，最常用的就是用于一些立体声的控件，我们需要同时对左右声道进行控制，因为多了一个声道，参数也就相应地多了一个shift偏移</p>
<h5 id="kcontrol创建过程"><a href="#kcontrol创建过程" class="headerlink" title="kcontrol创建过程"></a>kcontrol创建过程</h5><p>codec驱动在在进行kcontrol的定义后，会对<code>struct snd_soc_component_driver</code>的<code>controls</code>和<code>num_controls</code>成员进行填充。在声卡的初始化过程中，会调用<code>soc_probe_link_components()</code>对dai_link上的所有component进行初始化设置，其中包括了kcontrol的创建<code>snd_soc_add_component_controls()</code>，其创建过程如下：</p>
<p><img src="https://raw.githubusercontent.com/JackHuang021/images/master/20240409143156.png"></p>
<h5 id="es8336-kcontrol定义示例"><a href="#es8336-kcontrol定义示例" class="headerlink" title="es8336 kcontrol定义示例"></a>es8336 kcontrol定义示例</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sound/soc/codec/es8336.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">es8336_snd_controls</span>[] =</span> &#123;</span><br><span class="line">	<span class="comment">/* HP OUT VOLUME */</span></span><br><span class="line">	SOC_DOUBLE_TLV(<span class="string">&quot;HP Playback Volume&quot;</span>, ES8336_CPHP_ICAL_VOL_REG18,</span><br><span class="line">		       <span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, hpout_vol_tlv),</span><br><span class="line">	<span class="comment">/* HPMIXER VOLUME Control */</span></span><br><span class="line">	SOC_DOUBLE_TLV(<span class="string">&quot;HPMixer Gain&quot;</span>, ES8336_HPMIX_VOL_REG16,</span><br><span class="line">		       <span class="number">0</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">0</span>, hpmixer_gain_tlv),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DAC Digital controls */</span></span><br><span class="line">	SOC_DOUBLE_R_TLV(<span class="string">&quot;DAC Playback Volume&quot;</span>, ES8336_DAC_VOLL_REG33,</span><br><span class="line">			 ES8336_DAC_VOLR_REG34, <span class="number">0</span>, <span class="number">0xC0</span>, <span class="number">1</span>, dac_vol_tlv),</span><br><span class="line"></span><br><span class="line">	SOC_SINGLE(<span class="string">&quot;Enable DAC Soft Ramp&quot;</span>, ES8336_DAC_SET1_REG30, <span class="number">4</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">	SOC_SINGLE(<span class="string">&quot;DAC Soft Ramp Rate&quot;</span>, ES8336_DAC_SET1_REG30, <span class="number">2</span>, <span class="number">4</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">	SOC_ENUM(<span class="string">&quot;Playback Polarity&quot;</span>, dacpol),</span><br><span class="line">	SOC_SINGLE(<span class="string">&quot;DAC Notch Filter&quot;</span>, ES8336_DAC_SET2_REG31, <span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">	SOC_SINGLE(<span class="string">&quot;DAC Double Fs Mode&quot;</span>, ES8336_DAC_SET2_REG31, <span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">	SOC_SINGLE(<span class="string">&quot;DAC Volume Control-LeR&quot;</span>, ES8336_DAC_SET2_REG31, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">	SOC_SINGLE(<span class="string">&quot;DAC Stereo Enhancement&quot;</span>, ES8336_DAC_SET3_REG32, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* +20dB D2SE PGA Control */</span></span><br><span class="line">	SOC_SINGLE_TLV(<span class="string">&quot;MIC Boost&quot;</span>, ES8336_ADC_D2SEPGA_REG24,</span><br><span class="line">		       <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, mic_bst_tlv),</span><br><span class="line">	<span class="comment">/* 0-+24dB Lineinput PGA Control */</span></span><br><span class="line">	SOC_SINGLE_TLV(<span class="string">&quot;Input PGA&quot;</span>, ES8336_ADC_PGAGAIN_REG23,</span><br><span class="line">		       <span class="number">4</span>, <span class="number">8</span>, <span class="number">0</span>, linin_pga_tlv),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 填充到struct snd_soc_component_driver */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component_driver</span> <span class="title">soc_component_dev_es8336</span> =</span> &#123;</span><br><span class="line">	.probe =	es8336_probe,</span><br><span class="line">	.remove =	es8336_remove,</span><br><span class="line">	.suspend =	es8336_suspend,</span><br><span class="line">	.resume =	es8336_resume,</span><br><span class="line">	.set_bias_level = es8336_set_bias_level,</span><br><span class="line"></span><br><span class="line">	.controls = es8336_snd_controls,</span><br><span class="line">	.num_controls = ARRAY_SIZE(es8336_snd_controls),</span><br><span class="line">	.dapm_widgets = es8336_dapm_widgets,</span><br><span class="line">	.num_dapm_widgets = ARRAY_SIZE(es8336_dapm_widgets),</span><br><span class="line">	.dapm_routes = es8336_dapm_routes,</span><br><span class="line">	.num_dapm_routes = ARRAY_SIZE(es8336_dapm_routes),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="应用层访问Control设备"><a href="#应用层访问Control设备" class="headerlink" title="应用层访问Control设备"></a>应用层访问Control设备</h5><p>Control设备的文件操作集，<code>struct file_operations snd_ctl_f_ops</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sound/core/control.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">snd_ctl_f_ops</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">	.owner =	THIS_MODULE,</span><br><span class="line">	.read =		snd_ctl_read,</span><br><span class="line">	.open =		snd_ctl_open,</span><br><span class="line">	.release =	snd_ctl_release,</span><br><span class="line">	.llseek =	no_llseek,</span><br><span class="line">	.poll =		snd_ctl_poll,</span><br><span class="line">	.unlocked_ioctl =	snd_ctl_ioctl,</span><br><span class="line">	.compat_ioctl =	snd_ctl_ioctl_compat,</span><br><span class="line">	.fasync =	snd_ctl_fasync,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="PCM设备"><a href="#PCM设备" class="headerlink" title="PCM设备"></a>PCM设备</h3><p>PCM设备是挂载<code>struct snd_card</code>的devices链表下的一个snd device，一个pcm实例由一个playback stream和一个capture stream组成，这两个stream又分别有一个或多个substream组成，在嵌入式系统中，通常不会有这么复杂，大多数情况下是一个声卡，一个pcm实例，pcm下面有一个playback stream和capture stream，playback和capture下面各自有一个substream</p>
<h4 id="ALSA中pcm相关的数据结构"><a href="#ALSA中pcm相关的数据结构" class="headerlink" title="ALSA中pcm相关的数据结构"></a>ALSA中pcm相关的数据结构</h4><p><code>struct snd_pcm</code>，pcm使用<code>struct snd_pcm</code>数据结构来描述，一个pcm实例由一个playback stream和一个capture stream组成，这两个stream又分别有一个或者多个substream组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/pcm.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span> &#123;</span></span><br><span class="line">	<span class="comment">/* 指向pcm_runtime-&gt;card-&gt;snd_card */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">card</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	<span class="comment">/* pcm设备编号 这里一般情况下就是rtd-&gt;num的值 */</span></span><br><span class="line">	<span class="keyword">int</span> device; <span class="comment">/* device number */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> info_flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> dev_class;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> dev_subclass;</span><br><span class="line">	<span class="keyword">char</span> id[<span class="number">64</span>];</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">80</span>];</span><br><span class="line">	<span class="comment">/* streams[0]表示placyback stream，streams[1]表示capture stream */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_str</span> <span class="title">streams</span>[2];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">open_mutex</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> open_wait;</span><br><span class="line">	<span class="keyword">void</span> *private_data;</span><br><span class="line">	<span class="keyword">void</span> (*private_free) (struct snd_pcm *pcm);</span><br><span class="line">	<span class="keyword">bool</span> internal; <span class="comment">/* pcm is for internal use only */</span></span><br><span class="line">	<span class="keyword">bool</span> nonatomic; <span class="comment">/* whole PCM operations are in non-atomic context */</span></span><br><span class="line">	<span class="keyword">bool</span> no_device_suspend; <span class="comment">/* don&#x27;t invoke device PM suspend */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_SND_PCM_OSS)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_oss</span> <span class="title">oss</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_pcm_str</code>，用于表示pcm stream，snd_pcm_str的主要作用就是指向<code>snd_pcm_substream</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_str</span> &#123;</span></span><br><span class="line">	<span class="comment">/* </span></span><br><span class="line"><span class="comment">	 * stream方向：</span></span><br><span class="line"><span class="comment">	 * SNDRV_PCM_STREAM_PLAYBACK表示播放</span></span><br><span class="line"><span class="comment">	 * SNDRV_PCM_STREAM_CAPTURE表示捕获 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> stream;				<span class="comment">/* stream (direction) */</span></span><br><span class="line">	<span class="comment">/* 指向所属pcm */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span> *<span class="title">pcm</span>;</span></span><br><span class="line">	<span class="comment">/* -- substreams -- */</span></span><br><span class="line">	<span class="comment">/* substream的个数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> substream_count;</span><br><span class="line">	<span class="comment">/* substream的打开标志 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> substream_opened;</span><br><span class="line">	<span class="comment">/* 用来链接所有的substream */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">substream</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_SND_PCM_OSS)</span></span><br><span class="line">	<span class="comment">/* -- OSS things -- */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_oss_stream</span> <span class="title">oss</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SND_VERBOSE_PROCFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_info_entry</span> *<span class="title">proc_root</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SND_PCM_XRUN_DEBUG</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> xrun_debug;	<span class="comment">/* 0 = disabled, 1 = verbose, 2 = stacktrace */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol</span> *<span class="title">chmap_kctl</span>;</span> <span class="comment">/* channel-mapping controls */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_pcm_substream</code>，用于表pcm substream</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> &#123;</span></span><br><span class="line">	<span class="comment">/* 指向对应的snd_pcm和snd_pcm_str */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span> *<span class="title">pcm</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_str</span> *<span class="title">pstr</span>;</span></span><br><span class="line">	<span class="comment">/* 指向pcm_runtime */</span></span><br><span class="line">	<span class="keyword">void</span> *private_data;		<span class="comment">/* copied from pcm-&gt;private_data */</span></span><br><span class="line">	<span class="keyword">int</span> number;</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">32</span>];			<span class="comment">/* substream name */</span></span><br><span class="line">	<span class="keyword">int</span> stream;			<span class="comment">/* stream (direction) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pm_qos_request</span> <span class="title">latency_pm_qos_req</span>;</span> <span class="comment">/* pm_qos request */</span></span><br><span class="line">	<span class="keyword">size_t</span> buffer_bytes_max;	<span class="comment">/* limit ring buffer size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_dma_buffer</span> <span class="title">dma_buffer</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> dma_max;</span><br><span class="line">	<span class="comment">/* -- hardware operations -- */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="comment">/* -- runtime information -- */</span></span><br><span class="line">	<span class="comment">/* pcm 运行时实例，读写数据的时候由它来控制 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_runtime</span> *<span class="title">runtime</span>;</span></span><br><span class="line">        <span class="comment">/* -- timer section -- */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_timer</span> *<span class="title">timer</span>;</span>		<span class="comment">/* timer */</span></span><br><span class="line">	<span class="keyword">unsigned</span> timer_running: <span class="number">1</span>;	<span class="comment">/* time is running */</span></span><br><span class="line">	<span class="keyword">long</span> wait_time;	<span class="comment">/* time in ms for R/W to wait for avail */</span></span><br><span class="line">	<span class="comment">/* -- next substream -- */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="comment">/* -- linked substreams -- */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">link_list</span>;</span>	<span class="comment">/* linked list member */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_group</span> <span class="title">self_group</span>;</span>	<span class="comment">/* fake group for non linked substream (with substream lock inside) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_group</span> *<span class="title">group</span>;</span>		<span class="comment">/* pointer to current group */</span></span><br><span class="line">	<span class="comment">/* -- assigned files -- */</span></span><br><span class="line">	<span class="keyword">int</span> ref_count;</span><br><span class="line">	<span class="keyword">atomic_t</span> mmap_count;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> f_flags;</span><br><span class="line">	<span class="keyword">void</span> (*pcm_release)(struct snd_pcm_substream *);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pid</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_SND_PCM_OSS)</span></span><br><span class="line">	<span class="comment">/* -- OSS things -- */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_oss_substream</span> <span class="title">oss</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SND_VERBOSE_PROCFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_info_entry</span> *<span class="title">proc_root</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_SND_VERBOSE_PROCFS */</span></span></span><br><span class="line">	<span class="comment">/* misc flags */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> hw_opened: <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> managed_buffer_alloc:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_pcm_hw_params</code>结构体，用于配置音频硬件参数的结构体，比如通道数、采样率、数据格式等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includ/uapi/sound/asound.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_hw_params</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_mask</span> <span class="title">masks</span>[<span class="title">SNDRV_PCM_HW_PARAM_LAST_MASK</span> -</span></span><br><span class="line"><span class="class">			       <span class="title">SNDRV_PCM_HW_PARAM_FIRST_MASK</span> + 1];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_mask</span> <span class="title">mres</span>[5];</span>	<span class="comment">/* reserved masks */</span></span><br><span class="line">	<span class="comment">/* 用于描述各个硬件参数的取值范围 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_interval</span> <span class="title">intervals</span>[<span class="title">SNDRV_PCM_HW_PARAM_LAST_INTERVAL</span> -</span></span><br><span class="line"><span class="class">				        <span class="title">SNDRV_PCM_HW_PARAM_FIRST_INTERVAL</span> + 1];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_interval</span> <span class="title">ires</span>[9];</span>	<span class="comment">/* reserved intervals */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> rmask;		<span class="comment">/* W: requested masks */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cmask;		<span class="comment">/* R: changed masks */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> info;		<span class="comment">/* R: Info flags for returned setup */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> msbits;		<span class="comment">/* R: used most significant bits */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> rate_num;		<span class="comment">/* R: rate numerator */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> rate_den;		<span class="comment">/* R: rate denominator */</span></span><br><span class="line">	<span class="keyword">snd_pcm_uframes_t</span> fifo_size;	<span class="comment">/* R: chip FIFO size in frames */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> reserved[<span class="number">64</span>];	<span class="comment">/* reserved for future */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="ASoC中pcm相关的数据结构"><a href="#ASoC中pcm相关的数据结构" class="headerlink" title="ASoC中pcm相关的数据结构"></a>ASoC中pcm相关的数据结构</h4><p><code>struct snd_soc_pcm_stream</code>，用于描述SoC pcm stream的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc.h</span></span><br><span class="line"><span class="comment">/* SoC PCM stream information */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *stream_name;</span><br><span class="line">	<span class="comment">/* 数据传输的位宽 */</span></span><br><span class="line">	u64 formats;			<span class="comment">/* SNDRV_PCM_FMTBIT_* */</span></span><br><span class="line">	<span class="comment">/* 音频采样率 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> rates;		<span class="comment">/* SNDRV_PCM_RATE_* */</span></span><br><span class="line">	<span class="comment">/* 最低 最高采样率 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> rate_min;		<span class="comment">/* min rate */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> rate_max;		<span class="comment">/* max rate */</span></span><br><span class="line">	<span class="comment">/* 最少通道数 最大通道数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> channels_min;	<span class="comment">/* min channels */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> channels_max;	<span class="comment">/* max channels */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> sig_bits;		<span class="comment">/* number of bits of content */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_soc_pcm_runtime</code>，在注册声卡时会调用<code>soc_new_pcm_runtime()</code>为每一个<code>dai_link</code>分配一个<code>snd_soc_pcm_runtime</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc.h</span></span><br><span class="line"><span class="comment">/* SoC machine DAI configuration, glues a codec and cpu DAI together */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_runtime</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="comment">/* 指向ASoC sound card */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_card</span> *<span class="title">card</span>;</span></span><br><span class="line">	<span class="comment">/* 指向ASoC sound card中对应的dai_link */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> *<span class="title">dai_link</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_ops</span> <span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> params_select; <span class="comment">/* currently selected param for dai link */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Dynamic PCM BE runtime data */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dpcm_runtime</span> <span class="title">dpcm</span>[2];</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">long</span> pmdown_time;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* runtime devices */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span> *<span class="title">pcm</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_compr</span> *<span class="title">compr</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * dais = cpu_dai + codec_dai</span></span><br><span class="line"><span class="comment">	 * see</span></span><br><span class="line"><span class="comment">	 *	soc_new_pcm_runtime()</span></span><br><span class="line"><span class="comment">	 *	asoc_rtd_to_cpu()</span></span><br><span class="line"><span class="comment">	 *	asoc_rtd_to_codec()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/* 用于保存当前音频数据链路上的dai，包括cpu dai, codec dai */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> **<span class="title">dais</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_codecs;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_cpus;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">playback_widget</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">capture_widget</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span> <span class="title">delayed_work</span>;</span></span><br><span class="line">	<span class="keyword">void</span> (*close_delayed_work_func)(struct snd_soc_pcm_runtime *rtd);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">debugfs_dpcm_root</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 为ASoC声卡设备的每个pcm runtime会分配一个编号，从0开始 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num; <span class="comment">/* 0-based and monotonic increasing */</span></span><br><span class="line">	<span class="comment">/* 将当前的pcm runtime链接到ASoC sound card的rtd_list中 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span> <span class="comment">/* rtd list of the soc card */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* function mark */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_startup</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_hw_params</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_trigger</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_compr_stream</span>  *<span class="title">mark_compr_startup</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* bit field */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> pop_wait:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> fe_compr:<span class="number">1</span>; <span class="comment">/* for Dynamic PCM */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> num_components;</span><br><span class="line">	<span class="comment">/* 指向存储当前dai_link上的platform以及codec的component */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component</span> *<span class="title">components</span>[];</span> <span class="comment">/* CPU/Codec/Platform */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="PCM设备创建过程"><a href="#PCM设备创建过程" class="headerlink" title="PCM设备创建过程"></a>PCM设备创建过程</h4><p><img src="https://raw.githubusercontent.com/JackHuang021/images/master/20240410153336.png"></p>
<h3 id="DAPM相关"><a href="#DAPM相关" class="headerlink" title="DAPM相关"></a>DAPM相关</h3><p>DAPM是Dynamic Audio Power Management的缩写，即动态音频电源管理，是独立于内核其他PM的一套音频电源管理系统，DAPM对所有用户应用程序来说是完全透明的，电源切换的过程都在ASoC核心内完成，DAPM根据当前激活的音频流对声卡中的Mixer等进行配置，来决定音频控件的电源打开和关闭，达到省电的目的</p>
<h4 id="Widget介绍"><a href="#Widget介绍" class="headerlink" title="Widget介绍"></a>Widget介绍</h4><p>Widget是具备路径和电源管理的kcontrol，可以理解为kcontrol的进一步升级和封装，ASoC把系统划分为多个dapm域，每个widget属于某个dapm域，比如同一个codec中的widgets通常位于同一个dapm域，而platform上的widget可能又会位于另一个dapm域中</p>
<h5 id="相关数据结构"><a href="#相关数据结构" class="headerlink" title="相关数据结构"></a>相关数据结构</h5><p><code>struct snd_soc_dapm_widget</code>，用来描述Widget</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc_dapm.h</span></span><br><span class="line"><span class="comment">/* dapm widget */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">snd_soc_dapm_type</span> <span class="title">id</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;		<span class="comment">/* widget name */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *sname;	<span class="comment">/* stream name */</span></span><br><span class="line">	<span class="comment">/* 链接到snd_soc_card的widgets链表 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> *priv;				<span class="comment">/* widget specific data */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">regulator</span> *<span class="title">regulator</span>;</span>		<span class="comment">/* attached regulator */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">pinctrl</span>;</span>		<span class="comment">/* attached pinctrl */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* dapm control */</span></span><br><span class="line">	<span class="comment">/* 用于dapm控制的寄存器地址 */</span></span><br><span class="line">	<span class="keyword">int</span> reg;				<span class="comment">/* negative reg = no direct dapm */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> shift;			<span class="comment">/* bits to shift */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mask;			<span class="comment">/* non-shifted mask */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> on_val;			<span class="comment">/* on state value */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> off_val;			<span class="comment">/* off state value */</span></span><br><span class="line">	<span class="comment">/* 表示widget的上电状态 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> power:<span class="number">1</span>;			<span class="comment">/* block power status */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> active:<span class="number">1</span>;			<span class="comment">/* active stream on DAC, ADC&#x27;s */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> connected:<span class="number">1</span>;		<span class="comment">/* connected codec pin */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="keyword">new</span>:<span class="number">1</span>;			<span class="comment">/* cnew complete */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> force:<span class="number">1</span>;			<span class="comment">/* force state */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> ignore_suspend:<span class="number">1</span>;         <span class="comment">/* kept enabled over suspend */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> new_power:<span class="number">1</span>;		<span class="comment">/* power from this run */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> power_checked:<span class="number">1</span>;		<span class="comment">/* power checked this run */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> is_supply:<span class="number">1</span>;		<span class="comment">/* Widget is a supply type widget */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> is_ep:<span class="number">2</span>;			<span class="comment">/* Widget is a endpoint type widget */</span></span><br><span class="line">	<span class="keyword">int</span> subseq;				<span class="comment">/* sort within widget type */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*power_check)(struct snd_soc_dapm_widget *w);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* external events */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> event_flags;		<span class="comment">/* flags to specify event types */</span></span><br><span class="line">	<span class="keyword">int</span> (*event)(struct snd_soc_dapm_widget*, struct snd_kcontrol *, <span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* kcontrols that relate to this widget */</span></span><br><span class="line">	<span class="keyword">int</span> num_kcontrols;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> *<span class="title">kcontrol_news</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol</span> **<span class="title">kcontrols</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dobj</span> <span class="title">dobj</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* widget input and output edges */</span></span><br><span class="line">	<span class="comment">/* edge[0] 链接输出端连接的struct snd_soc_dapm_path */</span></span><br><span class="line">	<span class="comment">/* edge[1] 链接输入端连接的struct snd_soc_dapm_path */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">edges</span>[2];</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* used during DAPM updates */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">work_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">power_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">dirty</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * endpoints[0]保存从当前widget向前遍历，连接至SND_SOC_DAPM_EP_SOURCE</span></span><br><span class="line"><span class="comment">	 * 类型端点的路径数量</span></span><br><span class="line"><span class="comment">	 * endpoints[1]保存从当前widget向后遍历，连接至SND_SOC_DAPM_EP_SINK</span></span><br><span class="line"><span class="comment">	 * 类型端点的路径数量</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> endpoints[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">clk</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> channel;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_soc_dapm_context</code>，描述dapm域</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc_dapm.h</span></span><br><span class="line"><span class="comment">/* DAPM context */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">snd_soc_bias_level</span> <span class="title">bias_level</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> idle_bias_off:<span class="number">1</span>; <span class="comment">/* Use BIAS_OFF instead of STANDBY */</span></span><br><span class="line">	<span class="comment">/* Go to BIAS_OFF in suspend if the DAPM context is idle */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> suspend_bias_off:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span> <span class="comment">/* from parent - for debug */</span></span><br><span class="line">	<span class="comment">/* 所属的component */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component</span> *<span class="title">component</span>;</span> <span class="comment">/* parent component */</span></span><br><span class="line">	<span class="comment">/* 所属的snd_soc_card */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_card</span> *<span class="title">card</span>;</span> <span class="comment">/* parent card */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* used during DAPM updates */</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">snd_soc_bias_level</span> <span class="title">target_bias_level</span>;</span></span><br><span class="line">	<span class="comment">/* 链接到snd_soc_card的dapm_list链表中 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_wcache</span> <span class="title">path_sink_cache</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_wcache</span> <span class="title">path_source_cache</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">debugfs_dapm</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="辅助宏定义widget"><a href="#辅助宏定义widget" class="headerlink" title="辅助宏定义widget"></a>辅助宏定义widget</h5><p>DAPM系统提供的一些辅助宏定义来定义各种类型的widget和它所用到的dapm kcontrol（这些由DAPM系统提供的辅助宏定义的kcontrol我们统一称为dapm kcontrol，以便和普通的kcontrol进行区分），这些宏定义在<code>include/sound/soc_dapm.h</code>中，分类为了4个不同域的widget辅助定义宏</p>
<p>platform域widget，一般是一些需要物理连接的输入、输出接口，这些widget是没有寄存器控制位来控制widget的电源状态的，因此reg字段被设置为SND_SOC_NOPM</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc_dapm.h</span></span><br><span class="line"><span class="comment">/* platform domain */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_SIGGEN(wname) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_siggen, .name = wname, .kcontrol_news = NULL, \</span></span><br><span class="line"><span class="meta">	.num_kcontrols = 0, .reg = SND_SOC_NOPM &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_SINK(wname) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_sink, .name = wname, .kcontrol_news = NULL, \</span></span><br><span class="line"><span class="meta">	.num_kcontrols = 0, .reg = SND_SOC_NOPM &#125;</span></span><br><span class="line"><span class="comment">/* 对应codec芯片的输入引脚 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_INPUT(wname) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_input, .name = wname, .kcontrol_news = NULL, \</span></span><br><span class="line"><span class="meta">	.num_kcontrols = 0, .reg = SND_SOC_NOPM &#125;</span></span><br><span class="line"><span class="comment">/* 对应codec芯片的输出引脚 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_OUTPUT(wname) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_output, .name = wname, .kcontrol_news = NULL, \</span></span><br><span class="line"><span class="meta">	.num_kcontrols = 0, .reg = SND_SOC_NOPM &#125;</span></span><br><span class="line"><span class="comment">/* 对应麦克风 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_MIC(wname, wevent) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_mic, .name = wname, .kcontrol_news = NULL, \</span></span><br><span class="line"><span class="meta">	.num_kcontrols = 0, .reg = SND_SOC_NOPM, .event = wevent, \</span></span><br><span class="line"><span class="meta">	.event_flags = SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD&#125;</span></span><br><span class="line"><span class="comment">/* 对应耳机 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_HP(wname, wevent) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_hp, .name = wname, .kcontrol_news = NULL, \</span></span><br><span class="line"><span class="meta">	.num_kcontrols = 0, .reg = SND_SOC_NOPM, .event = wevent, \</span></span><br><span class="line"><span class="meta">	.event_flags = SND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_PRE_PMD&#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_SPK(wname, wevent) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_spk, .name = wname, .kcontrol_news = NULL, \</span></span><br><span class="line"><span class="meta">	.num_kcontrols = 0, .reg = SND_SOC_NOPM, .event = wevent, \</span></span><br><span class="line"><span class="meta">	.event_flags = SND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_PRE_PMD&#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_LINE(wname, wevent) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_line, .name = wname, .kcontrol_news = NULL, \</span></span><br><span class="line"><span class="meta">	.num_kcontrols = 0, .reg = SND_SOC_NOPM, .event = wevent, \</span></span><br><span class="line"><span class="meta">	.event_flags = SND_SOC_DAPM_POST_PMU | SND_SOC_DAPM_PRE_PMD&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_INIT_REG_VAL(wreg, wshift, winvert) \</span></span><br><span class="line"><span class="meta">	.reg = wreg, .mask = 1, .shift = wshift, \</span></span><br><span class="line"><span class="meta">	.on_val = winvert ? 0 : 1, .off_val = winvert ? 1 : 0</span></span><br></pre></td></tr></table></figure>

<p>path域widget，一般指codec内部的Mixer、Mux、Switch、Demux等控制音频路径的widget，这些widget是有相应的寄存器控制的，DAPM框架在扫描和更新音频路径时，会利用这些寄存器来控制widget的电源状态</p>
<p>es8336的示例，通过es8336的datasheet可知，Left Hp Mixer通过ES8336_HPMIX_PDN_REG15的bit4来控制Left Hp Mixer的电源状态，而es8336_out_left_mixer是通过ES8336_HPMIX_SWITCH_REG14寄存器的bit7来控制Left DAC的开关</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Output mixer  */</span></span><br><span class="line">SND_SOC_DAPM_MIXER(<span class="string">&quot;Left Hp mixer&quot;</span>, ES8336_HPMIX_PDN_REG15,</span><br><span class="line">			<span class="number">4</span>, <span class="number">1</span>, &amp;es8336_out_left_mix[<span class="number">0</span>],</span><br><span class="line">			ARRAY_SIZE(es8336_out_left_mix)),</span><br><span class="line"></span><br><span class="line"><span class="comment">/* headphone Output Mixer */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">es8336_out_left_mix</span>[] =</span> &#123;</span><br><span class="line">	SOC_DAPM_SINGLE(<span class="string">&quot;LLIN Switch&quot;</span>, ES8336_HPMIX_SWITCH_REG14,</span><br><span class="line">			<span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">	SOC_DAPM_SINGLE(<span class="string">&quot;Left DAC Switch&quot;</span>, ES8336_HPMIX_SWITCH_REG14,</span><br><span class="line">			<span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>stream域widget，指那些需要处理音频数据流的widget，例如ADC、DAC、AIF IN、AIF OUT等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc-dapm.h</span></span><br><span class="line"><span class="comment">/* stream domain */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_AIF_IN(wname, stname, wchan, wreg, wshift, winvert) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_aif_in, .name = wname, .sname = stname, \</span></span><br><span class="line"><span class="meta">	.channel = wchan, SND_SOC_DAPM_INIT_REG_VAL(wreg, wshift, winvert), &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_AIF_IN_E(wname, stname, wchan, wreg, wshift, winvert, \</span></span><br><span class="line"><span class="meta">			      wevent, wflags)				\</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_aif_in, .name = wname, .sname = stname, \</span></span><br><span class="line"><span class="meta">	.channel = wchan, SND_SOC_DAPM_INIT_REG_VAL(wreg, wshift, winvert), \</span></span><br><span class="line"><span class="meta">	.event = wevent, .event_flags = wflags &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_AIF_OUT(wname, stname, wchan, wreg, wshift, winvert) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_aif_out, .name = wname, .sname = stname, \</span></span><br><span class="line"><span class="meta">	.channel = wchan, SND_SOC_DAPM_INIT_REG_VAL(wreg, wshift, winvert), &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_AIF_OUT_E(wname, stname, wchan, wreg, wshift, winvert, \</span></span><br><span class="line"><span class="meta">			     wevent, wflags)				\</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_aif_out, .name = wname, .sname = stname, \</span></span><br><span class="line"><span class="meta">	.channel = wchan, SND_SOC_DAPM_INIT_REG_VAL(wreg, wshift, winvert), \</span></span><br><span class="line"><span class="meta">	.event = wevent, .event_flags = wflags &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_DAC(wname, stname, wreg, wshift, winvert) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_dac, .name = wname, .sname = stname, \</span></span><br><span class="line"><span class="meta">	SND_SOC_DAPM_INIT_REG_VAL(wreg, wshift, winvert) &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_DAC_E(wname, stname, wreg, wshift, winvert, \</span></span><br><span class="line"><span class="meta">			   wevent, wflags)				\</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_dac, .name = wname, .sname = stname, \</span></span><br><span class="line"><span class="meta">	SND_SOC_DAPM_INIT_REG_VAL(wreg, wshift, winvert), \</span></span><br><span class="line"><span class="meta">	.event = wevent, .event_flags = wflags&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_ADC(wname, stname, wreg, wshift, winvert) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_adc, .name = wname, .sname = stname, \</span></span><br><span class="line"><span class="meta">	SND_SOC_DAPM_INIT_REG_VAL(wreg, wshift, winvert), &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_ADC_E(wname, stname, wreg, wshift, winvert, \</span></span><br><span class="line"><span class="meta">			   wevent, wflags)				\</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_adc, .name = wname, .sname = stname, \</span></span><br><span class="line"><span class="meta">	SND_SOC_DAPM_INIT_REG_VAL(wreg, wshift, winvert), \</span></span><br><span class="line"><span class="meta">	.event = wevent, .event_flags = wflags&#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_SOC_DAPM_CLOCK_SUPPLY(wname) \</span></span><br><span class="line"><span class="meta">&#123;	.id = snd_soc_dapm_clock_supply, .name = wname, \</span></span><br><span class="line"><span class="meta">	.reg = SND_SOC_NOPM, .event = dapm_clock_event, \</span></span><br><span class="line"><span class="meta">	.event_flags = SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD &#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="辅助宏定义dapm-kcontrol"><a href="#辅助宏定义dapm-kcontrol" class="headerlink" title="辅助宏定义dapm kcontrol"></a>辅助宏定义dapm kcontrol</h5><p>对于音频路径上的Mixer或Mux类型的widget，他们包含了若干个kcontrol，dapm利用这些kcontrol完成音频的控制</p>
<p>es8336驱动中的示例，用来控制Left DAC的开关</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* headphone Output Mixer */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">es8336_out_left_mix</span>[] =</span> &#123;</span><br><span class="line">	SOC_DAPM_SINGLE(<span class="string">&quot;LLIN Switch&quot;</span>, ES8336_HPMIX_SWITCH_REG14,</span><br><span class="line">			<span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">	SOC_DAPM_SINGLE(<span class="string">&quot;Left DAC Switch&quot;</span>, ES8336_HPMIX_SWITCH_REG14,</span><br><span class="line">			<span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br></pre></td></tr></table></figure>

<h4 id="Path介绍"><a href="#Path介绍" class="headerlink" title="Path介绍"></a>Path介绍</h4><p>DAPM提出了path的概念，path将一个widget的输出端和另一个widget的输入端连接在一起</p>
<p>path使用<code>struct snd_soc_dapm_path</code>来描述，当widget之间发生连接关系时，snd_soc_dapm_path作为连接者，它的source字段会指向路径起始端widget，sink字段会指向路径目标端的widget</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc_dapm.h</span></span><br><span class="line"><span class="comment">/* dapm audio path between two widgets */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * source (input) and sink (output) widgets</span></span><br><span class="line"><span class="comment">	 * The union is for convience, since it is a lot nicer to type</span></span><br><span class="line"><span class="comment">	 * p-&gt;source, rather than p-&gt;node[SND_SOC_DAPM_DIR_IN]</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* 输入端widget */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">source</span>;</span></span><br><span class="line">			<span class="comment">/* 输出端widget */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">sink</span>;</span></span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">node</span>[2];</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* status */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * connect用来表示source widget和sink widget之间的连接状态 </span></span><br><span class="line"><span class="comment">	 * 如果在source widget和sink widget中间有kcontrol可以控制通断，</span></span><br><span class="line"><span class="comment">	 * 那么connect表示的就是kcontrol的通断状态，对于两个直连的widget，</span></span><br><span class="line"><span class="comment">	 * connect值始终为1。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	u32 connect:<span class="number">1</span>;	<span class="comment">/* source and sink widgets are connected */</span></span><br><span class="line">	u32 walking:<span class="number">1</span>;  <span class="comment">/* path is in the process of being walked */</span></span><br><span class="line">	u32 weak:<span class="number">1</span>;	<span class="comment">/* path ignored for power management */</span></span><br><span class="line">	u32 is_supply:<span class="number">1</span>;	<span class="comment">/* At least one of the connected widgets is a supply */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*connected)(struct snd_soc_dapm_widget *source,</span><br><span class="line">			 struct snd_soc_dapm_widget *sink);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_node</span>[2];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_kcontrol</span>;</span></span><br><span class="line">	<span class="comment">/* 链接到声卡的paths链表中 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="complete-path"><a href="#complete-path" class="headerlink" title="complete path"></a>complete path</h5><p>complete path: 一条完整的音频路径必须要有起点和终点，我们把这些起点和终点widget称之为端点widget</p>
<p>下面这些类型的widget可以称为端点widget</p>
<table>
<thead>
<tr>
<th align="center">分类</th>
<th align="left">widget类型</th>
</tr>
</thead>
<tbody><tr>
<td align="center">codec的输入输出引脚</td>
<td align="left">snd_soc_dapm_input, SND_SOC_DAPM_EP_SOURCE类型端点</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">snd_soc_dapm_output, SND_SOC_DAPM_EP_SINK类型端点</td>
</tr>
<tr>
<td align="center">codec外接音频设备</td>
<td align="left">snd_soc_dapm_mic, SND_SOC_DAPM_EP_SOURCE类型端点</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">snd_soc_dapm_hp, SND_SOC_DAPM_EP_SINK类型端点</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">snd_soc_dapm_spk, SND_SOC_DAPM_EP_SINK类型端点</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">snd_soc_dapm_line</td>
</tr>
<tr>
<td align="center">dai widget</td>
<td align="left">snd_soc_dapm_dai_in</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">snd_soc_dapm_dai_out</td>
</tr>
</tbody></table>
<p>DAPM要给一个widget上电的其中一个条件是：这个widget位于一条完整路径上，即向前、向后查找连接的widget均能找到一个端点widget，并且路径上的widget、path都是处于连接状态的</p>
<h4 id="Route介绍"><a href="#Route介绍" class="headerlink" title="Route介绍"></a>Route介绍</h4><p>一个路径包括：起始端widget -&gt; path的输入端 -&gt; path的输出 -&gt; 目标端widget，DAPM使用<code>struct snd_soc_dapm_route</code>结构来描述这样一个完整路径route</p>
<p><code>struct snd_soc_dapm_route</code>结构体，用来描述一个路径</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DAPM audio route definition.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Defines an audio route originating at source via control and finishing</span></span><br><span class="line"><span class="comment"> * at sink.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> &#123;</span></span><br><span class="line">	<span class="comment">/* 指向目标端widget的名称 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *sink;</span><br><span class="line">	<span class="comment">/* 指向负责控制该连接所对应的kcontrol名称 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *control;</span><br><span class="line">	<span class="comment">/* 指向起始端widget的名称 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *source;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Note: currently only supported for links where source is a supply */</span></span><br><span class="line">	<span class="keyword">int</span> (*connected)(struct snd_soc_dapm_widget *source,</span><br><span class="line">			 struct snd_soc_dapm_widget *sink);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dobj</span> <span class="title">dobj</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里直接使用名称来描述连接关系，所有定义好的route，最后都要注册到dapm系统中，dapm会根据这些名字找出相应的widget，并动态地生成所需要的snd_soc_dapm_path结构，正确地处理各个链表和指针的关系，实现两个widget之间的连接。</p>
<h3 id="machine驱动-以Phytium-DP音频为例"><a href="#machine驱动-以Phytium-DP音频为例" class="headerlink" title="machine驱动 以Phytium DP音频为例"></a>machine驱动 以Phytium DP音频为例</h3><p>这里通过飞腾dp音频驱动来看一下DP声卡注册的过程</p>
<p><code>struct snd_soc_card</code>结构体定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sound/soc/phytium/pmdk_dp.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_card</span> <span class="title">pmdk</span> =</span> &#123;</span><br><span class="line">	.name = <span class="string">&quot;PMDK-I2S&quot;</span>,</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line"></span><br><span class="line">	.dapm_widgets = pmdk_dp_dapm_widgets,</span><br><span class="line">	.num_dapm_widgets = ARRAY_SIZE(pmdk_dp_dapm_widgets),</span><br><span class="line">	.controls = pmdk_controls,</span><br><span class="line">	.num_controls = ARRAY_SIZE(pmdk_controls),</span><br><span class="line">	.dapm_routes = pmdk_dp_audio_map,</span><br><span class="line">	.num_dapm_routes = ARRAY_SIZE(pmdk_dp_audio_map),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>struct snd_soc_dai_link</code>的定义，这里用到了<code>SND_SOC_DAILINK_DEFS</code>及<code>SND_SOC_DAILINK_REG</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">SND_SOC_DAILINK_DEFS(pmdk_dp0_dai,</span><br><span class="line">	DAILINK_COMP_ARRAY(COMP_CPU(<span class="string">&quot;phytium-i2s-dp0&quot;</span>)),</span><br><span class="line">	DAILINK_COMP_ARRAY(COMP_CODEC(<span class="string">&quot;hdmi-audio-codec.1346918656&quot;</span>, <span class="string">&quot;i2s-hifi&quot;</span>)),</span><br><span class="line">	DAILINK_COMP_ARRAY(COMP_PLATFORM(<span class="string">&quot;snd-soc-dummy&quot;</span>)));</span><br><span class="line"></span><br><span class="line">SND_SOC_DAILINK_DEFS(pmdk_dp1_dai,</span><br><span class="line">	DAILINK_COMP_ARRAY(COMP_CPU(<span class="string">&quot;phytium-i2s-dp1&quot;</span>)),</span><br><span class="line">	DAILINK_COMP_ARRAY(COMP_CODEC(<span class="string">&quot;hdmi-audio-codec.1346918657&quot;</span>, <span class="string">&quot;i2s-hifi&quot;</span>)),</span><br><span class="line">	DAILINK_COMP_ARRAY(COMP_PLATFORM(<span class="string">&quot;snd-soc-dummy&quot;</span>)));</span><br><span class="line"></span><br><span class="line">SND_SOC_DAILINK_DEFS(pmdk_dp2_dai,</span><br><span class="line">	DAILINK_COMP_ARRAY(COMP_CPU(<span class="string">&quot;phytium-i2s-dp2&quot;</span>)),</span><br><span class="line">	DAILINK_COMP_ARRAY(COMP_CODEC(<span class="string">&quot;hdmi-audio-codec.1346918658&quot;</span>, <span class="string">&quot;i2s-hifi&quot;</span>)),</span><br><span class="line">	DAILINK_COMP_ARRAY(COMP_PLATFORM(<span class="string">&quot;snd-soc-dummy&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> <span class="title">pmdk_dai_local</span>[] =</span> &#123;</span><br><span class="line">&#123;</span><br><span class="line">	.name = <span class="string">&quot;Phytium dp0-audio&quot;</span>,</span><br><span class="line">	.stream_name = <span class="string">&quot;Playback&quot;</span>,</span><br><span class="line">	.dai_fmt = SMDK_DAI_FMT,</span><br><span class="line">	.init = pmdk_dp0_init,</span><br><span class="line">	SND_SOC_DAILINK_REG(pmdk_dp0_dai),</span><br><span class="line">&#125;,&#123;</span><br><span class="line">	.name = <span class="string">&quot;Phytium dp1-audio&quot;</span>,</span><br><span class="line">	.stream_name = <span class="string">&quot;Playback&quot;</span>,</span><br><span class="line">	.dai_fmt = SMDK_DAI_FMT,</span><br><span class="line">	.init = pmdk_dp1_init,</span><br><span class="line">	SND_SOC_DAILINK_REG(pmdk_dp1_dai),</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">	.name = <span class="string">&quot;Phytium dp2-audio&quot;</span>,</span><br><span class="line">	.stream_name = <span class="string">&quot;Playback&quot;</span>,</span><br><span class="line">	.dai_fmt = SMDK_DAI_FMT,</span><br><span class="line">	.init = pmdk_dp2_init,</span><br><span class="line">	SND_SOC_DAILINK_REG(pmdk_dp2_dai),</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>展开其中一个dai_link为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snc_soc_dai_link_component</span> <span class="title">pmdk_dp0_dai_cpus</span>[] =</span> &#123;</span><br><span class="line">    .dai_name = <span class="string">&quot;phytium_i2s_dp0&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snc_soc_dai_link_component</span> <span class="title">pmdk_dp0_dai_codecs</span>[] =</span> &#123;</span><br><span class="line">    .name = <span class="string">&quot;hdmi-audio-codec.1346918656&quot;</span>,</span><br><span class="line">    .dai_name = <span class="string">&quot;i2s_hifi&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snc_soc_dai_link_component</span> <span class="title">pmdk_dp0_dai_platforms</span>[] =</span> &#123;</span><br><span class="line">    .name = <span class="string">&quot;snd_soc_dummy&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SND_SOC_DAILINK_REG(pmdk_dp0_dai);</span><br><span class="line"></span><br><span class="line">SND_SOC_DAILINK_REGx(pmdk_dp0_dai,</span><br><span class="line">                     SND_SOC_DAILINK_REG3,</span><br><span class="line">                     SND_SOC_DAILINK_REG2,</span><br><span class="line">                     SND_SOC_DAILINK_REG1)(pmdk_dp0_dai)</span><br><span class="line"></span><br><span class="line">SND_SOC_DAILINK_REG1(pmdk_dp0_dai)</span><br><span class="line"></span><br><span class="line">SND_SOC_DAILINK_REG3(pmdk_dp0_dai_cpus, pmdk_dp0_dai_codecs, pmdk_dp0_dai_platforms)</span><br><span class="line"></span><br><span class="line">.cpu            = pdmk_dp0_dai_cpus,</span><br><span class="line">.num_cpus       = ARRAY_SIZE(pdmk_dp0_dai_cpus),</span><br><span class="line">.codecs         = pmdk_dp0_dai_codecs,</span><br><span class="line">.num_codecs     = ARRAY_SIZE(pdmk_dp0_dai_codecs),</span><br><span class="line">.platforms      = pmdk_dp0_dai_platforms</span><br><span class="line">.num_platforms  = ARRAY_SIZE(pdmk_dp0_dai_platforms)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> struct snd_soc_dai_link pmdk_dai_local[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;Phyitum dp0-audio&quot;</span>,</span><br><span class="line">        .stream_name = <span class="string">&quot;Playback&quot;</span>,</span><br><span class="line">        .dai_fmt = SMDK_DAI_FMT,</span><br><span class="line">        .init = pmdk_dp0_init,</span><br><span class="line">        .cpu            = pdmk_dp0_dai_cpus,</span><br><span class="line">        .num_cpus       = ARRAY_SIZE(pdmk_dp0_dai_cpus),</span><br><span class="line">        .codecs         = pmdk_dp0_dai_codecs,</span><br><span class="line">        .num_codecs     = ARRAY_SIZE(pdmk_dp0_dai_codecs),</span><br><span class="line">        .platforms      = pmdk_dp0_dai_platforms</span><br><span class="line">        .num_platforms  = ARRAY_SIZE(pdmk_dp0_dai_platforms)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="machine驱动-以asoc-simple-card为例"><a href="#machine驱动-以asoc-simple-card为例" class="headerlink" title="machine驱动 以asoc-simple-card为例"></a>machine驱动 以asoc-simple-card为例</h3><p>ASoC声卡的注册从machine驱动开始，machine驱动相关的主要数据结构如下：</p>
<ul>
<li><code>struct snd_soc_card</code>: ASoC中的核心数据结构，对ASoC声卡进行抽象</li>
<li><code>struct snd_soc_dai_link</code>: 用来描述音频数据链路，在snd_soc_dai_link中，指定了platform, codec, codec_dai, cpu_dai的名字</li>
<li><code>struct snd_soc_dai_link_components</code>: 保存components的名称和设备树节点，用于后续查找component</li>
</ul>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p><code>struct snd_soc_card</code>结构体，对ASoC声卡的抽象，machine驱动需要对其实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc.h</span></span><br><span class="line"><span class="comment">/* SoC card */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_card</span> &#123;</span></span><br><span class="line">	<span class="comment">/* 声卡的名称，如果使用设备树，解析simple-audio-card,name得到 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *long_name;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *driver_name;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *components;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DMI</span></span><br><span class="line">	<span class="keyword">char</span> dmi_longname[<span class="number">80</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_DMI */</span></span></span><br><span class="line">	<span class="keyword">char</span> topology_shortname[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="comment">/* 指向ALSA声卡 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">snd_card</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">dapm_mutex</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Mutex for PCM operations */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">pcm_mutex</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">snd_soc_pcm_subclass</span> <span class="title">pcm_subclass</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*probe)(struct snd_soc_card *card);</span><br><span class="line">	<span class="keyword">int</span> (*late_probe)(struct snd_soc_card *card);</span><br><span class="line">	<span class="keyword">int</span> (*remove)(struct snd_soc_card *card);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* the pre and post PM functions are used to do any PM work before and</span></span><br><span class="line"><span class="comment">	 * after the codec and DAI&#x27;s do any PM work. */</span></span><br><span class="line">	<span class="keyword">int</span> (*suspend_pre)(struct snd_soc_card *card);</span><br><span class="line">	<span class="keyword">int</span> (*suspend_post)(struct snd_soc_card *card);</span><br><span class="line">	<span class="keyword">int</span> (*resume_pre)(struct snd_soc_card *card);</span><br><span class="line">	<span class="keyword">int</span> (*resume_post)(struct snd_soc_card *card);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* callbacks */</span></span><br><span class="line">	<span class="keyword">int</span> (*set_bias_level)(struct snd_soc_card *,</span><br><span class="line">			      struct snd_soc_dapm_context *dapm,</span><br><span class="line">			      <span class="keyword">enum</span> snd_soc_bias_level level);</span><br><span class="line">	<span class="keyword">int</span> (*set_bias_level_post)(struct snd_soc_card *,</span><br><span class="line">				   struct snd_soc_dapm_context *dapm,</span><br><span class="line">				   <span class="keyword">enum</span> snd_soc_bias_level level);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*add_dai_link)(struct snd_soc_card *,</span><br><span class="line">			    struct snd_soc_dai_link *link);</span><br><span class="line">	<span class="keyword">void</span> (*remove_dai_link)(struct snd_soc_card *,</span><br><span class="line">			    struct snd_soc_dai_link *link);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">long</span> pmdown_time;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* CPU &lt;--&gt; Codec DAI links  */</span></span><br><span class="line">	<span class="comment">/* 存储所有的dai link */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> *<span class="title">dai_link</span>;</span>  <span class="comment">/* predefined links only */</span></span><br><span class="line">	<span class="comment">/* dai_link的数量 */</span></span><br><span class="line">	<span class="keyword">int</span> num_links;  <span class="comment">/* predefined links only */</span></span><br><span class="line">	<span class="comment">/* 链接所有的snd_soc_pcm_runtime，一个dai_link对应一个runtime */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">rtd_list</span>;</span></span><br><span class="line">	<span class="comment">/* pcm runtime的数量 */</span></span><br><span class="line">	<span class="keyword">int</span> num_rtd;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* optional codec specific configuration */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec_conf</span> *<span class="title">codec_conf</span>;</span></span><br><span class="line">	<span class="keyword">int</span> num_configs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * optional auxiliary devices such as amplifiers or codecs with DAI</span></span><br><span class="line"><span class="comment">	 * link unused</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_aux_dev</span> *<span class="title">aux_dev</span>;</span></span><br><span class="line">	<span class="keyword">int</span> num_aux_devs;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">aux_comp_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> *<span class="title">controls</span>;</span></span><br><span class="line">	<span class="keyword">int</span> num_controls;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Card-specific routes and widgets.</span></span><br><span class="line"><span class="comment">	 * Note: of_dapm_xxx for Device Tree; Otherwise for driver build-in.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">dapm_widgets</span>;</span></span><br><span class="line">	<span class="keyword">int</span> num_dapm_widgets;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> *<span class="title">dapm_routes</span>;</span></span><br><span class="line">	<span class="keyword">int</span> num_dapm_routes;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">of_dapm_widgets</span>;</span></span><br><span class="line">	<span class="keyword">int</span> num_of_dapm_widgets;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> *<span class="title">of_dapm_routes</span>;</span></span><br><span class="line">	<span class="keyword">int</span> num_of_dapm_routes;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* lists of probed devices belonging to this card */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">component_dev_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">widgets</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">paths</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">dapm_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">dapm_dirty</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* attached dynamic objects */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">dobj_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Generic DAPM context for the card */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> <span class="title">dapm</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_stats</span> <span class="title">dapm_stats</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_update</span> *<span class="title">update</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">debugfs_card_root</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM_SLEEP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">deferred_resume_work</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	u32 pop_time;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* bit field */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> instantiated:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> topology_shortname_created:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> fully_routed:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> disable_route_checks:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> probed:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> component_chaining:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> *drvdata;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_soc_dai_link</code>结构体，描述音频数据链路</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> &#123;</span></span><br><span class="line">	<span class="comment">/* config - must be set by machine driver */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;			<span class="comment">/* Codec name */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *stream_name;		<span class="comment">/* Stream name */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * You MAY specify the link&#x27;s CPU-side device, either by device name,</span></span><br><span class="line"><span class="comment">	 * or by DT/OF node, but not both. If this information is omitted,</span></span><br><span class="line"><span class="comment">	 * the CPU-side DAI is matched using .cpu_dai_name only, which hence</span></span><br><span class="line"><span class="comment">	 * must be globally unique. These fields are currently typically used</span></span><br><span class="line"><span class="comment">	 * only for codec to codec links, or systems using device tree.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * You MAY specify the DAI name of the CPU DAI. If this information is</span></span><br><span class="line"><span class="comment">	 * omitted, the CPU-side DAI is matched using .cpu_name/.cpu_of_node</span></span><br><span class="line"><span class="comment">	 * only, which only works well when that device exposes a single DAI.</span></span><br><span class="line"><span class="comment">	 */</span> </span><br><span class="line">	<span class="comment">/* 保存当前dai_link上所有的cpu components */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">cpus</span>;</span></span><br><span class="line">	<span class="comment">/* cpu components的数量，一般来说1个dai_link只对应1个cpu和1个codec */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_cpus;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * You MUST specify the link&#x27;s codec, either by device name, or by</span></span><br><span class="line"><span class="comment">	 * DT/OF node, but not both.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/* You MUST specify the DAI name within the codec */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">codecs</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_codecs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * You MAY specify the link&#x27;s platform/PCM/DMA driver, either by</span></span><br><span class="line"><span class="comment">	 * device name, or by DT/OF node, but not both. Some forms of link</span></span><br><span class="line"><span class="comment">	 * do not need a platform. In such case, platforms are not mandatory.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">platforms</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_platforms;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> id;	<span class="comment">/* optional ID for machine driver link identification */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> *<span class="title">params</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_params;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 数字音频接口格式 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dai_fmt;           <span class="comment">/* format to set on init */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">snd_soc_dpcm_trigger</span> <span class="title">trigger</span>[2];</span> <span class="comment">/* trigger type for DPCM */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* codec/machine specific init - e.g. add machine controls */</span></span><br><span class="line">	<span class="keyword">int</span> (*init)(struct snd_soc_pcm_runtime *rtd);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* codec/machine specific exit - dual of init() */</span></span><br><span class="line">	<span class="keyword">void</span> (*<span class="built_in">exit</span>)(struct snd_soc_pcm_runtime *rtd);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* optional hw_params re-writing for BE and FE sync */</span></span><br><span class="line">	<span class="keyword">int</span> (*be_hw_params_fixup)(struct snd_soc_pcm_runtime *rtd,</span><br><span class="line">			struct snd_pcm_hw_params *params);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* machine stream operations */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_compr_ops</span> *<span class="title">compr_ops</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Mark this pcm with non atomic ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nonatomic:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* For unidirectional dai links */</span></span><br><span class="line">	<span class="comment">/* 仅支持播放和录制标志 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> playback_only:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> capture_only:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Keep DAI active over suspend */</span></span><br><span class="line">	<span class="comment">/* 是否在挂起时保持DAI的活动状态 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ignore_suspend:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Symmetry requirements */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_rate:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_channels:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_sample_bits:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Do not create a PCM for this DAI link (Backend link) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> no_pcm:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This DAI link can route to other DAI links at runtime (Frontend)*/</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dynamic:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DPCM capture and Playback support */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_capture:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_playback:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DPCM used FE &amp; BE merged format */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_merged_format:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">/* DPCM used FE &amp; BE merged channel */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_merged_chan:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">/* DPCM used FE &amp; BE merged rate */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_merged_rate:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* pmdown_time is ignored at stop */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ignore_pmdown_time:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Do not create a PCM for this DAI link (Backend link) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ignore:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This flag will reorder stop sequence. By enabling this flag</span></span><br><span class="line"><span class="comment">	 * DMA controller stop sequence will be invoked first followed by</span></span><br><span class="line"><span class="comment">	 * CPU DAI driver stop sequence</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> stop_dma_first:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SND_SOC_TOPOLOGY</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dobj</span> <span class="title">dobj</span>;</span> <span class="comment">/* For topology */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>aso_simple_priv</code>结构体，asoc-simple-card驱动中集成的数据结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/simple_card_util.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">asoc_simple_priv</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_card</span> <span class="title">snd_card</span>;</span></span><br><span class="line">	<span class="comment">/* dai_props是和dai_link对应的 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">simple_dai_props</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">asoc_simple_dai</span> *<span class="title">cpu_dai</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">asoc_simple_dai</span> *<span class="title">codec_dai</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">cpus</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">codecs</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">platforms</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">asoc_simple_data</span> <span class="title">adata</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec_conf</span> *<span class="title">codec_conf</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">prop_nums</span> <span class="title">num</span>;</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> mclk_fs;</span><br><span class="line">	&#125; *dai_props;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">asoc_simple_jack</span> <span class="title">hp_jack</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">asoc_simple_jack</span> <span class="title">mic_jack</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> *<span class="title">dai_link</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">asoc_simple_dai</span> *<span class="title">dais</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">dlcs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> <span class="title">dummy</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec_conf</span> *<span class="title">codec_conf</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">pa_gpio</span>;</span></span><br><span class="line">	<span class="comment">/* ALSA PCM操作集 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_selectable:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> force_dpcm:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct link_info</code>用于保存dai_link信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_info</span> &#123;</span></span><br><span class="line">	<span class="comment">/* 表示音频数据链路的数量 */</span></span><br><span class="line">	<span class="keyword">int</span> link; <span class="comment">/* number of link */</span></span><br><span class="line">	<span class="comment">/* 表示当前正在处理的是第几个cpu */</span></span><br><span class="line">	<span class="keyword">int</span> cpu;  <span class="comment">/* turn for CPU / Codec */</span></span><br><span class="line">	<span class="comment">/* 保存每条音频数据链路所需的信息 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">prop_nums</span> <span class="title">num</span>[<span class="title">SNDRV_MAX_LINKS</span>];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prop_nums</span> &#123;</span></span><br><span class="line">	<span class="comment">/* 分别表示该dai_link下cpu codec platform的数量 */</span></span><br><span class="line">	<span class="keyword">int</span> cpus;</span><br><span class="line">	<span class="keyword">int</span> codecs;</span><br><span class="line">	<span class="keyword">int</span> platforms;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="asoc-simple-card设备树节点描述"><a href="#asoc-simple-card设备树节点描述" class="headerlink" title="asoc-simple-card设备树节点描述"></a>asoc-simple-card设备树节点描述</h4><p>E2000Q设备树sound-card节点描述</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sound_card: sound &#123;</span><br><span class="line">	compatible = <span class="string">&quot;simple-audio-card&quot;</span>;</span><br><span class="line">	simple-audio-card,format = <span class="string">&quot;i2s&quot;</span>;</span><br><span class="line">	simple-audio-card,name = <span class="string">&quot;phytium,pe220x-i2s-audio&quot;</span>;</span><br><span class="line">	simple-audio-card,pin-switches = <span class="string">&quot;mic-in&quot;</span>;</span><br><span class="line">	simple-audio-card,widgets = <span class="string">&quot;Microphone&quot;</span>,<span class="string">&quot;mic-in&quot;</span>;</span><br><span class="line">	simple-audio-card,routing = <span class="string">&quot;MIC2&quot;</span>,<span class="string">&quot;mic-in&quot;</span>;</span><br><span class="line">	simple-audio-card,cpu &#123;</span><br><span class="line">		sound-dai = &lt;&amp;i2s0&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">	simple-audio-card,codec&#123;</span><br><span class="line">		sound-dai = &lt;&amp;codec0&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>simple-audio-card的各个属性设置<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/devicetree/bindings/sound/simple-card.yaml">simple-card.yaml</a></p>
<ol>
<li><code>simple-audio-card,name</code>： 指定声卡的名称为“phytium,pe220x-i2s-audio”;</li>
<li><code>simple-audio-card,audio</code>： 指定数字音频接口格式为<code>i2s</code></li>
<li><code>simple-audio-card,widge</code> ： 在alsa驱动中，使用widget描述具有路径电源管理的kcontrol，每个条目都是一对字符串，其中第一个是widget模板名称，在machine驱动中只有确定的几种”Microphone（表示麦克风）”、“Headphone（表示耳机）”、“Speaker（表示扬声器）”、“Line（表示线路）”；第二个是widget实例名称，可以自由定义</li>
<li><code>simple-audio-card,routing</code>：配置与codec物理输入引脚、物理输出引脚连接的路径，每个条目都是一对字符串，第一个事目的(sink)，第二个是源(source)，E2000设备树中的描述指的是将其中名字为<code>mic-in</code>的widget连接到名字为<code>MIC2</code>的widget</li>
<li><code>simple-audio-card,cpu</code>：指定cpu接入音频编码的dai</li>
<li><code>simple-audio-card,codec</code>：指定codec接入cpu的dai</li>
</ol>
<p>asoc-simple-card machine驱动probe的流程</p>
<p>总结来说，machine驱动的工作内容如下</p>
<ul>
<li>构造一个<code>struct snd_soc_dai_link</code>，将cpu和codec关联起来</li>
<li>负责创建<code>struct snd_soc_card</code>即asoc-sound-card这个结构体，走<code>devm_snd_soc_register_card()</code>将其注册到asoc中</li>
</ul>
<h3 id="plarform驱动-以phytium-i2s驱动为例"><a href="#plarform驱动-以phytium-i2s驱动为例" class="headerlink" title="plarform驱动 以phytium i2s驱动为例"></a>plarform驱动 以phytium i2s驱动为例</h3><p>以phytium phytium-i2s.c platform驱动为例进行分析</p>
<h4 id="相关结构体"><a href="#相关结构体" class="headerlink" title="相关结构体"></a>相关结构体</h4><p><code>struct i2s_bus</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sound/soc/phytium/local.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2s_bus</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2sc_bus</span> <span class="title">core</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">card</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pci_dev</span> *<span class="title">pci</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">prepare_mutex</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct i2s_phytium</code>用于驱动集中管理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sound/soc/phytium/local.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2s_phytium</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">azx</span> <span class="title">chip</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">substream</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">pdev</span>;</span></span><br><span class="line">	u32 paddr;</span><br><span class="line">	<span class="comment">/* i2s 寄存器基地址 */</span></span><br><span class="line">	<span class="keyword">void</span> __iomem *regs;</span><br><span class="line">	<span class="comment">/* DDMA 寄存器基地址 */</span></span><br><span class="line">	<span class="keyword">void</span> __iomem *regs_db;</span><br><span class="line">	<span class="keyword">int</span> irq_id;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* for pending irqs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">irq_pending_work</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* sync probing */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">completion</span> <span class="title">probe_wait</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">probe_work</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* extra flags */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> pcie:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> irq_pending_warned:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> probe_continued:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i2s_dp:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i2s_reg_comp1;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i2s_reg_comp2;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">clk</span>;</span></span><br><span class="line">	<span class="comment">// capability用来标识当前是否有播放和录音的能力</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> capability;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> quirks;</span><br><span class="line">	u32 fifo_th;</span><br><span class="line">	<span class="keyword">int</span> active;</span><br><span class="line">	u32 xfer_resolution;</span><br><span class="line">	u32 ccr;</span><br><span class="line">	u32 clk_base;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2s_clk_config_data</span> <span class="title">config</span>;</span></span><br><span class="line"></span><br><span class="line">	  <span class="comment">/*azx_dev*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2s_stream</span> <span class="title">core</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct azx</code>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">azx</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2s_bus</span> <span class="title">bus</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">card</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pci_dev</span> *<span class="title">pci</span>;</span></span><br><span class="line">	<span class="keyword">int</span> dev_index;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* playback stream数量，默认是1 */</span></span><br><span class="line">	<span class="keyword">int</span> playback_streams;</span><br><span class="line">	<span class="comment">/* playback索引偏移，默认为0 */</span></span><br><span class="line">	<span class="keyword">int</span> playback_index_offset;</span><br><span class="line">	<span class="comment">/* capture stream数量，默认是1 */</span></span><br><span class="line">	<span class="keyword">int</span> capture_streams;</span><br><span class="line">	<span class="comment">/* capture索引偏移，默认在playback索引之后 */</span></span><br><span class="line">	<span class="keyword">int</span> capture_index_offset;</span><br><span class="line">	<span class="keyword">int</span> num_streams;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Register interaction */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2s_controller_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* locks */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">open_mutex</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* PCM */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">pcm_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* flags */</span></span><br><span class="line">	<span class="keyword">int</span> bdl_pos_adj;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> running:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> region_requested:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> disabled:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct azx_dev</code>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">azx_dev</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2s_stream</span> <span class="title">core</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> irq_pending:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct i2sc_bus</code>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2s_io_ops</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*dma_alloc_pages)(struct i2sc_bus *bus, <span class="keyword">int</span> type, <span class="keyword">size_t</span> size,</span><br><span class="line">			       struct snd_dma_buffer *buf);</span><br><span class="line">	<span class="keyword">void</span> (*dma_free_pages)(struct i2sc_bus *bus,</span><br><span class="line">			       struct snd_dma_buffer *buf);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sound/soc/phytium/local.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2sc_bus</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2s_bus_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="comment">/* 用于dma内存分配和释放的操作 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2s_io_ops</span> *<span class="title">io_ops</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2s_ext_bus_ops</span> *<span class="title">ext_ops</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* h/w resources */</span></span><br><span class="line">	<span class="comment">/* I2S控制器寄存器基地址 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> addr;</span><br><span class="line">	<span class="comment">/* DMA控制器映射后的寄存器基地址 */</span></span><br><span class="line">	<span class="keyword">void</span> __iomem *remap_addr;</span><br><span class="line">	<span class="comment">/* 中断号 */</span></span><br><span class="line">	<span class="keyword">int</span> irq;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* codec linked list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">codec_list</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_codecs;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> unsol_rp, unsol_wp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">unsol_work</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_dma_buffer</span> <span class="title">bdl0</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_dma_buffer</span> <span class="title">bdl1</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* i2s_stream linked list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">stream_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> reverse_assign;		<span class="comment">/* assign devices in reverse order */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> bdl_pos_adj;		<span class="comment">/* BDL position adjustment */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* locks */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> reg_lock;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct i2s_stream</code>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2s_stream</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2sc_bus</span> *<span class="title">bus</span>;</span></span><br><span class="line">	<span class="comment">/* 用于描述该stream的dma内存 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_dma_buffer</span> <span class="title">bdl</span>;</span> <span class="comment">/* BDL buffer */</span></span><br><span class="line">	__le32 *posbuf;		<span class="comment">/* position buffer pointer */</span></span><br><span class="line">	<span class="comment">/* stream的方向 */</span></span><br><span class="line">	<span class="keyword">int</span> direction;		<span class="comment">/* playback / capture (SNDRV_PCM_STREAM_*) */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> bufsize;	<span class="comment">/* size of the play buffer in bytes */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> period_bytes; <span class="comment">/* size of the period in bytes */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> frags;	<span class="comment">/* number for period in the play buffer */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> fifo_size;	<span class="comment">/* FIFO size */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DMA控制器映射后的寄存器基地址 */</span></span><br><span class="line">	<span class="keyword">void</span> __iomem *sd_addr;	<span class="comment">/* stream descriptor pointer */</span></span><br><span class="line"></span><br><span class="line">	u32 sd_int_sta_mask;	<span class="comment">/* stream int status mask */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* pcm support */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">substream</span>;</span>	<span class="comment">/* assigned substream,</span></span><br><span class="line"><span class="comment">						 * set in PCM open</span></span><br><span class="line"><span class="comment">						 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> format_val;	<span class="comment">/* format value to be set in the</span></span><br><span class="line"><span class="comment">					 * controller and the codec</span></span><br><span class="line"><span class="comment">					 */</span></span><br><span class="line">	<span class="comment">/* stream的标记，意义应该不大 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> stream_tag;	<span class="comment">/* assigned stream */</span></span><br><span class="line">	<span class="comment">/* stream的索引号 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> index;		<span class="comment">/* stream index */</span></span><br><span class="line">	<span class="keyword">int</span> assigned_key;		<span class="comment">/* last device# key assigned to */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> opened;</span><br><span class="line">	<span class="keyword">bool</span> running;</span><br><span class="line">	<span class="keyword">bool</span> prepared;</span><br><span class="line">	<span class="keyword">bool</span> no_period_wakeup;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> delay_negative_threshold;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="platform-driver注册过程"><a href="#platform-driver注册过程" class="headerlink" title="platform driver注册过程"></a>platform driver注册过程</h4><p>phytium i2s的设备树描述</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">i2s0: i2s@<span class="number">28009000</span> &#123;</span><br><span class="line">	compatible = <span class="string">&quot;phytium,i2s&quot;</span>;</span><br><span class="line">	reg = &lt;<span class="number">0x0</span> <span class="number">0x28009000</span> <span class="number">0x0</span> <span class="number">0x1000</span>&gt;,</span><br><span class="line">			&lt;<span class="number">0x0</span> <span class="number">0x28005000</span> <span class="number">0x0</span> <span class="number">0x1000</span>&gt;;</span><br><span class="line">	interrupts = &lt;GIC_SPI <span class="number">77</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">	clocks = &lt;&amp;sysclk_600mhz&gt;;</span><br><span class="line">	clock-names = <span class="string">&quot;i2s_clk&quot;</span>;</span><br><span class="line">	status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p><code>struct snd_soc_component_driver phyitum_i2s_component</code>的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sound/soc/phytium/phytium_i2s.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component_driver</span> <span class="title">phytium_i2s_component</span> =</span> &#123;</span><br><span class="line">	.name			= <span class="string">&quot;phytium-i2s&quot;</span>,</span><br><span class="line">	.pcm_construct	= phytium_pcm_new,</span><br><span class="line">	.suspend		= phyitum_i2s_suspend,</span><br><span class="line">	.resume 		= phytium_i2s_resume,</span><br><span class="line"></span><br><span class="line">	.open			= phytium_pcm_open,</span><br><span class="line">	.close			= phytium_pcm_close,</span><br><span class="line">	.hw_params 		= phytium_pcm_hw_params,</span><br><span class="line">	.prepare 		= phytium_pcm_prepare,</span><br><span class="line">	.hw_free		= phytium_pcm_hw_free,</span><br><span class="line">	.trigger		= phytium_pcm_trigger,</span><br><span class="line">	.pointer 		= phytium_pcm_pointer,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_soc_dai_driver phytium_i2s_dai</code>的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> <span class="title">phytium_i2s_dai_ops</span> =</span> &#123;</span><br><span class="line">	.hw_params	= phytium_i2s_hw_params,</span><br><span class="line">	.prepare	= phytium_i2s_prepare,</span><br><span class="line">	.trigger	= phytium_i2s_trigger,</span><br><span class="line">	.set_fmt	= phytium_i2s_set_fmt,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> <span class="title">phytium_i2s_dai</span> =</span> &#123;</span><br><span class="line">	.playback = &#123;</span><br><span class="line">		.stream_name = <span class="string">&quot;i2s-Playback&quot;</span>,</span><br><span class="line">		.channels_min = <span class="number">2</span>,</span><br><span class="line">		.channels_max = <span class="number">2</span>,</span><br><span class="line">		.rates = SNDRV_PCM_RATE_8000_192000,</span><br><span class="line">		.formats = SNDRV_PCM_FMTBIT_S8 |</span><br><span class="line">			   SNDRV_PCM_FMTBIT_S16_LE |</span><br><span class="line">			   SNDRV_PCM_FMTBIT_S20_LE |</span><br><span class="line">			   SNDRV_PCM_FMTBIT_S24_LE |</span><br><span class="line">			   SNDRV_PCM_FMTBIT_S32_LE,</span><br><span class="line">	&#125;,</span><br><span class="line">	.capture = &#123;</span><br><span class="line">		.stream_name = <span class="string">&quot;i2s-Capture&quot;</span>,</span><br><span class="line">		.channels_min = <span class="number">2</span>,</span><br><span class="line">		.channels_max = <span class="number">2</span>,</span><br><span class="line">		.rates = SNDRV_PCM_RATE_8000_192000,</span><br><span class="line">		.formats = SNDRV_PCM_FMTBIT_S8 |</span><br><span class="line">			   SNDRV_PCM_FMTBIT_S16_LE |</span><br><span class="line">			   SNDRV_PCM_FMTBIT_S20_LE |</span><br><span class="line">			   SNDRV_PCM_FMTBIT_S24_LE |</span><br><span class="line">			   SNDRV_PCM_FMTBIT_S32_LE,</span><br><span class="line">	&#125;,</span><br><span class="line">	.ops     = &amp;phytium_i2s_dai_ops,</span><br><span class="line">	.symmetric_rate = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="codec驱动-以es8336为例"><a href="#codec驱动-以es8336为例" class="headerlink" title="codec驱动 以es8336为例"></a>codec驱动 以es8336为例</h3><p>codec driver不应包含任何特定于目标平台或者设备的代码，</p>
<p>描述codec的最主要的几个数据结构分别是：</p>
<ul>
<li><code>struct snd_soc_dai</code>: 描述codec端的dai</li>
<li><code>struct snd_soc_dai_driver</code>: 描述dai的驱动，用于定义pcm的能力和操作集</li>
<li><code>struct snd_soc_component</code>: ASoC使用统一的数据结构来描述codec设备和platform设备，一个component对应一个模块</li>
<li><code>struct snd_soc_component_driver</code>: 描述component的驱动</li>
</ul>
<h4 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h4><p><code>struct snd_soc_component</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component</span> &#123;</span></span><br><span class="line">	<span class="comment">/* </span></span><br><span class="line"><span class="comment">	 * component名称 dai_link可以通过这个字段在全局链表component_list中查找对应的</span></span><br><span class="line"><span class="comment">	 * component</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name_prefix;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="comment">/* 该component绑定的snd_soc_card声卡 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_card</span> *<span class="title">card</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> active;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> suspended:<span class="number">1</span>; <span class="comment">/* is in suspend PM state */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 链接到全局链表 component_list上 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">card_aux_list</span>;</span> <span class="comment">/* for auxiliary bound components */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">card_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 用于管理component上的dai */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">dai_list</span>;</span></span><br><span class="line">	<span class="comment">/* component中dai的数量 */</span></span><br><span class="line">	<span class="keyword">int</span> num_dai;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">regmap</span> *<span class="title">regmap</span>;</span></span><br><span class="line">	<span class="keyword">int</span> val_bytes;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">io_mutex</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* attached dynamic objects */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">dobj_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * DO NOT use any of the fields below in drivers, they are temporary and</span></span><br><span class="line"><span class="comment">	 * are going to be removed again soon. If you use them in driver code</span></span><br><span class="line"><span class="comment">	 * the driver will be marked as BROKEN when these fields are removed.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Don&#x27;t use these, use snd_soc_component_get_dapm() */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> <span class="title">dapm</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* machine specific init */</span></span><br><span class="line">	<span class="keyword">int</span> (*init)(struct snd_soc_component *component);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* function mark */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_module</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_open</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_hw_params</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_trigger</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_compr_stream</span>  *<span class="title">mark_compr_open</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *mark_pm;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">debugfs_root</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *debugfs_prefix;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_soc_component_driver</code>，用于component的driver，例如phytium i2s的platform驱动中定义的<code>phytium_i2s_component</code>实例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc-component.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component_driver</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Default control and setup, added after probe() is run */</span></span><br><span class="line">	<span class="comment">/* 在codec的driver中一般会在驱动中直接进行定义并赋值到这几个成员 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> *<span class="title">controls</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_controls;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">dapm_widgets</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_dapm_widgets;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> *<span class="title">dapm_routes</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_dapm_routes;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 注册声卡时回调的probe函数 */</span></span><br><span class="line">	<span class="keyword">int</span> (*probe)(struct snd_soc_component *component);</span><br><span class="line">	<span class="keyword">void</span> (*remove)(struct snd_soc_component *component);</span><br><span class="line">	<span class="keyword">int</span> (*suspend)(struct snd_soc_component *component);</span><br><span class="line">	<span class="keyword">int</span> (*resume)(struct snd_soc_component *component);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 用于读写寄存器的值，假如使用了regmap就不需要实现这两个接口了 */</span></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*read)</span><span class="params">(struct snd_soc_component *component,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">unsigned</span> <span class="keyword">int</span> reg)</span></span>;</span><br><span class="line">	<span class="keyword">int</span> (*write)(struct snd_soc_component *component,</span><br><span class="line">		     <span class="keyword">unsigned</span> <span class="keyword">int</span> reg, <span class="keyword">unsigned</span> <span class="keyword">int</span> val);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* pcm creation and destruction */</span></span><br><span class="line">	<span class="keyword">int</span> (*pcm_construct)(struct snd_soc_component *component,</span><br><span class="line">			     struct snd_soc_pcm_runtime *rtd);</span><br><span class="line">	<span class="keyword">void</span> (*pcm_destruct)(struct snd_soc_component *component,</span><br><span class="line">			     struct snd_pcm *pcm);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* component wide operations */</span></span><br><span class="line">	<span class="keyword">int</span> (*set_sysclk)(struct snd_soc_component *component,</span><br><span class="line">			  <span class="keyword">int</span> clk_id, <span class="keyword">int</span> source, <span class="keyword">unsigned</span> <span class="keyword">int</span> freq, <span class="keyword">int</span> dir);</span><br><span class="line">	<span class="keyword">int</span> (*set_pll)(struct snd_soc_component *component, <span class="keyword">int</span> pll_id,</span><br><span class="line">		       <span class="keyword">int</span> source, <span class="keyword">unsigned</span> <span class="keyword">int</span> freq_in, <span class="keyword">unsigned</span> <span class="keyword">int</span> freq_out);</span><br><span class="line">	<span class="keyword">int</span> (*set_jack)(struct snd_soc_component *component,</span><br><span class="line">			struct snd_soc_jack *jack,  <span class="keyword">void</span> *data);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DT */</span></span><br><span class="line">	<span class="keyword">int</span> (*of_xlate_dai_name)(struct snd_soc_component *component,</span><br><span class="line">				 <span class="keyword">const</span> struct of_phandle_args *args,</span><br><span class="line">				 <span class="keyword">const</span> <span class="keyword">char</span> **dai_name);</span><br><span class="line">	<span class="keyword">int</span> (*of_xlate_dai_id)(struct snd_soc_component *comment,</span><br><span class="line">			       struct device_node *endpoint);</span><br><span class="line">	<span class="keyword">void</span> (*seq_notifier)(struct snd_soc_component *component,</span><br><span class="line">			     <span class="keyword">enum</span> snd_soc_dapm_type type, <span class="keyword">int</span> subseq);</span><br><span class="line">	<span class="keyword">int</span> (*stream_event)(struct snd_soc_component *component, <span class="keyword">int</span> event);</span><br><span class="line">	<span class="keyword">int</span> (*set_bias_level)(struct snd_soc_component *component,</span><br><span class="line">			      <span class="keyword">enum</span> snd_soc_bias_level level);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*open)(struct snd_soc_component *component,</span><br><span class="line">		    struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*close)(struct snd_soc_component *component,</span><br><span class="line">		     struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*ioctl)(struct snd_soc_component *component,</span><br><span class="line">		     struct snd_pcm_substream *substream,</span><br><span class="line">		     <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">void</span> *arg);</span><br><span class="line">	<span class="keyword">int</span> (*hw_params)(struct snd_soc_component *component,</span><br><span class="line">			 struct snd_pcm_substream *substream,</span><br><span class="line">			 struct snd_pcm_hw_params *params);</span><br><span class="line">	<span class="keyword">int</span> (*hw_free)(struct snd_soc_component *component,</span><br><span class="line">		       struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*prepare)(struct snd_soc_component *component,</span><br><span class="line">		       struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*trigger)(struct snd_soc_component *component,</span><br><span class="line">		       struct snd_pcm_substream *substream, <span class="keyword">int</span> cmd);</span><br><span class="line">	<span class="keyword">int</span> (*sync_stop)(struct snd_soc_component *component,</span><br><span class="line">			 struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">snd_pcm_uframes_t</span> (*pointer)(struct snd_soc_component *component,</span><br><span class="line">				     struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*get_time_info)(struct snd_soc_component *component,</span><br><span class="line">		struct snd_pcm_substream *substream, struct timespec64 *system_ts,</span><br><span class="line">		struct timespec64 *audio_ts,</span><br><span class="line">		struct snd_pcm_audio_tstamp_config *audio_tstamp_config,</span><br><span class="line">		struct snd_pcm_audio_tstamp_report *audio_tstamp_report);</span><br><span class="line">	<span class="keyword">int</span> (*copy_user)(struct snd_soc_component *component,</span><br><span class="line">			 struct snd_pcm_substream *substream, <span class="keyword">int</span> channel,</span><br><span class="line">			 <span class="keyword">unsigned</span> <span class="keyword">long</span> pos, <span class="keyword">void</span> __user *buf,</span><br><span class="line">			 <span class="keyword">unsigned</span> <span class="keyword">long</span> bytes);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *(*<span class="title">page</span>)(<span class="keyword">struct</span> <span class="title">snd_soc_component</span> *<span class="title">component</span>,</span></span><br><span class="line"><span class="class">			     <span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">substream</span>,</span></span><br><span class="line"><span class="class">			     <span class="title">unsigned</span> <span class="title">long</span> <span class="title">offset</span>);</span></span><br><span class="line">	<span class="keyword">int</span> (*mmap)(struct snd_soc_component *component,</span><br><span class="line">		    struct snd_pcm_substream *substream,</span><br><span class="line">		    struct vm_area_struct *vma);</span><br><span class="line">	<span class="keyword">int</span> (*ack)(struct snd_soc_component *component,</span><br><span class="line">		   struct snd_pcm_substream *substream);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_compress_ops</span> *<span class="title">compress_ops</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* probe ordering - for components with runtime dependencies */</span></span><br><span class="line">	<span class="comment">/* probe的顺序，一共有5个顺序，驱动初始化的过程中根据顺序进行component的probe */</span></span><br><span class="line">	<span class="keyword">int</span> probe_order;</span><br><span class="line">	<span class="keyword">int</span> remove_order;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * signal if the module handling the component should not be removed</span></span><br><span class="line"><span class="comment">	 * if a pcm is open. Setting this would prevent the module</span></span><br><span class="line"><span class="comment">	 * refcount being incremented in probe() but allow it be incremented</span></span><br><span class="line"><span class="comment">	 * when a pcm is opened and decremented when it is closed.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> module_get_upon_open:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* bits */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> idle_bias_on:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> suspend_bias_off:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> use_pmdown_time:<span class="number">1</span>; <span class="comment">/* care pmdown_time at stop */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> endianness:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> non_legacy_dai_naming:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* this component uses topology and ignore machine driver FEs */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *ignore_machine;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *topology_name_prefix;</span><br><span class="line">	<span class="keyword">int</span> (*be_hw_params_fixup)(struct snd_soc_pcm_runtime *rtd,</span><br><span class="line">				  struct snd_pcm_hw_params *params);</span><br><span class="line">	<span class="keyword">bool</span> use_dai_pcm_id;	<span class="comment">/* use DAI link PCM ID as PCM device number */</span></span><br><span class="line">	<span class="keyword">int</span> be_pcm_base;	<span class="comment">/* base device ID for all BE PCMs */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_soc_dai</code>，用来描述dai</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc_dai.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Digital Audio Interface runtime data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Holds runtime data for a DAI.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 指向dai_driver */</span></span><br><span class="line">	<span class="comment">/* driver ops */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DAI runtime info */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> stream_active[SNDRV_PCM_STREAM_LAST + <span class="number">1</span>]; <span class="comment">/* usage count */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">playback_widget</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">capture_widget</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DAI DMA data */</span></span><br><span class="line">	<span class="keyword">void</span> *playback_dma_data;</span><br><span class="line">	<span class="keyword">void</span> *capture_dma_data;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Symmetry data - only valid if symmetry is being enforced */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> rate;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> channels;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> sample_bits;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 指向component */</span></span><br><span class="line">	<span class="comment">/* parent platform/codec */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component</span> *<span class="title">component</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* CODEC TDM slot masks and params (for fixup) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tx_mask;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> rx_mask;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 链接到component的dai_list链表 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* function mark */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_startup</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_hw_params</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">mark_trigger</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_compr_stream</span>  *<span class="title">mark_compr_startup</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* bit field */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> probed:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_soc_dai_driver</code>，描述dai驱动</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc_dai.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Digital Audio Interface Driver.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Describes the Digital Audio Interface in terms of its ALSA, DAI and AC97</span></span><br><span class="line"><span class="comment"> * operations and capabilities. Codec and platform drivers will register this</span></span><br><span class="line"><span class="comment"> * structure for every DAI they have.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This structure covers the clocking, formating and ALSA operations for each</span></span><br><span class="line"><span class="comment"> * interface.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> &#123;</span></span><br><span class="line">	<span class="comment">/* DAI description */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="comment">/* dai标识符 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> base;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dobj</span> <span class="title">dobj</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DAI driver callbacks */</span></span><br><span class="line">	<span class="keyword">int</span> (*probe)(struct snd_soc_dai *dai);</span><br><span class="line">	<span class="keyword">int</span> (*remove)(struct snd_soc_dai *dai);</span><br><span class="line">	<span class="comment">/* compress dai */</span></span><br><span class="line">	<span class="keyword">int</span> (*compress_new)(struct snd_soc_pcm_runtime *rtd, <span class="keyword">int</span> num);</span><br><span class="line">	<span class="comment">/* Optional Callback used at pcm creation*/</span></span><br><span class="line">	<span class="keyword">int</span> (*pcm_new)(struct snd_soc_pcm_runtime *rtd,</span><br><span class="line">		       struct snd_soc_dai *dai);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ops */</span></span><br><span class="line">	<span class="comment">/* dai的操作集，codec和platform驱动需要实现它 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_cdai_ops</span> *<span class="title">cops</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DAI capabilities */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> <span class="title">capture</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> <span class="title">playback</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_rate:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_channels:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_sample_bits:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* probe ordering - for components with runtime dependencies */</span></span><br><span class="line">	<span class="keyword">int</span> probe_order;</span><br><span class="line">	<span class="keyword">int</span> remove_order;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct snd_soc_dai_ops</code>，dai的控制和参数配置操作集结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/sound/soc_dai.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * DAI clocking configuration, all optional.</span></span><br><span class="line"><span class="comment">	 * Called by soc_card drivers, normally in their hw_params.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/* 配置dai的时钟 */</span></span><br><span class="line">	<span class="keyword">int</span> (*set_sysclk)(struct snd_soc_dai *dai,</span><br><span class="line">		<span class="keyword">int</span> clk_id, <span class="keyword">unsigned</span> <span class="keyword">int</span> freq, <span class="keyword">int</span> dir);</span><br><span class="line">	<span class="keyword">int</span> (*set_pll)(struct snd_soc_dai *dai, <span class="keyword">int</span> pll_id, <span class="keyword">int</span> source,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> freq_in, <span class="keyword">unsigned</span> <span class="keyword">int</span> freq_out);</span><br><span class="line">	<span class="keyword">int</span> (*set_clkdiv)(struct snd_soc_dai *dai, <span class="keyword">int</span> div_id, <span class="keyword">int</span> div);</span><br><span class="line">	<span class="keyword">int</span> (*set_bclk_ratio)(struct snd_soc_dai *dai, <span class="keyword">unsigned</span> <span class="keyword">int</span> ratio);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * DAI format configuration</span></span><br><span class="line"><span class="comment">	 * Called by soc_card drivers, normally in their hw_params.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*set_fmt)(struct snd_soc_dai *dai, <span class="keyword">unsigned</span> <span class="keyword">int</span> fmt);</span><br><span class="line">	<span class="keyword">int</span> (*xlate_tdm_slot_mask)(<span class="keyword">unsigned</span> <span class="keyword">int</span> slots,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_mask);</span><br><span class="line">	<span class="keyword">int</span> (*set_tdm_slot)(struct snd_soc_dai *dai,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> tx_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> rx_mask,</span><br><span class="line">		<span class="keyword">int</span> slots, <span class="keyword">int</span> slot_width);</span><br><span class="line">	<span class="keyword">int</span> (*set_channel_map)(struct snd_soc_dai *dai,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> tx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_slot,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> rx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_slot);</span><br><span class="line">	<span class="keyword">int</span> (*get_channel_map)(struct snd_soc_dai *dai,</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_slot,</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_slot);</span><br><span class="line">	<span class="keyword">int</span> (*set_tristate)(struct snd_soc_dai *dai, <span class="keyword">int</span> tristate);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*set_stream)(struct snd_soc_dai *dai,</span><br><span class="line">			  <span class="keyword">void</span> *stream, <span class="keyword">int</span> direction);</span><br><span class="line">	<span class="keyword">void</span> *(*get_stream)(struct snd_soc_dai *dai, <span class="keyword">int</span> direction);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * DAI digital mute - optional.</span></span><br><span class="line"><span class="comment">	 * Called by soc-core to minimise any pops.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*mute_stream)(struct snd_soc_dai *dai, <span class="keyword">int</span> mute, <span class="keyword">int</span> stream);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ALSA PCM audio operations - all optional.</span></span><br><span class="line"><span class="comment">	 * Called by soc-core during audio PCM operations.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*startup)(struct snd_pcm_substream *,</span><br><span class="line">		struct snd_soc_dai *);</span><br><span class="line">	<span class="keyword">void</span> (*shutdown)(struct snd_pcm_substream *,</span><br><span class="line">		struct snd_soc_dai *);</span><br><span class="line">	<span class="comment">/* 配置PCM音频的硬件参数 */</span></span><br><span class="line">	<span class="keyword">int</span> (*hw_params)(struct snd_pcm_substream *,</span><br><span class="line">		struct snd_pcm_hw_params *, struct snd_soc_dai *);</span><br><span class="line">	<span class="comment">/* 释放PCM音频的硬件资源 */</span></span><br><span class="line">	<span class="keyword">int</span> (*hw_free)(struct snd_pcm_substream *,</span><br><span class="line">		struct snd_soc_dai *);</span><br><span class="line">	<span class="comment">/* 准备PCM音频操作 */</span></span><br><span class="line">	<span class="keyword">int</span> (*prepare)(struct snd_pcm_substream *,</span><br><span class="line">		struct snd_soc_dai *);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">NOTE:</span> Commands passed to the trigger function are not necessarily</span></span><br><span class="line"><span class="comment">	 * compatible with the current state of the dai. For example this</span></span><br><span class="line"><span class="comment">	 * sequence of commands is possible: START STOP STOP.</span></span><br><span class="line"><span class="comment">	 * So do not unconditionally use refcounting functions in the trigger</span></span><br><span class="line"><span class="comment">	 * function, e.g. clk_enable/disable.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	 <span class="comment">/* 触发PCM音频操作 */</span></span><br><span class="line">	<span class="keyword">int</span> (*trigger)(struct snd_pcm_substream *, <span class="keyword">int</span>,</span><br><span class="line">		struct snd_soc_dai *);</span><br><span class="line">	<span class="keyword">int</span> (*bespoke_trigger)(struct snd_pcm_substream *, <span class="keyword">int</span>,</span><br><span class="line">		struct snd_soc_dai *);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For hardware based FIFO caused delay reporting.</span></span><br><span class="line"><span class="comment">	 * Optional.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">snd_pcm_sframes_t</span> (*delay)(struct snd_pcm_substream *,</span><br><span class="line">		struct snd_soc_dai *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Format list for auto selection.</span></span><br><span class="line"><span class="comment">	 * Format will be increased if priority format was</span></span><br><span class="line"><span class="comment">	 * not selected.</span></span><br><span class="line"><span class="comment">	 * see</span></span><br><span class="line"><span class="comment">	 *	snd_soc_dai_get_fmt()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	u64 *auto_selectable_formats;</span><br><span class="line">	<span class="keyword">int</span> num_auto_selectable_formats;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* bit field */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> no_capture_mute:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h4 id="component注册过程"><a href="#component注册过程" class="headerlink" title="component注册过程"></a>component注册过程</h4><p>一般在codec和platform驱动中会调用<code>devm_snd_soc_register_component()</code>来注册component和dai，<code>devm_snd_soc_register_component</code>是带有资源管理的component注册函数，该函数会动态申请一个component，并将其添加到全局链表component_list中，同时会为每个dai driver动态分配一个dai，并建立dai与component、dai与dai driver的关系。</p>
<p>在Machine驱动中匹配codec，实际上就是根据音频数据链路snd_soc_dai_link codec指定的name去遍历component_list找到匹配的component，然后再根据dai_name从component-&gt;dai_list中获取到匹配的codec dai。</p>
<p><img src="https://raw.githubusercontent.com/JackHuang021/images/master/20240410171031.png"></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Jack
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://jackhuang021.github.io/archives/131a876a.html" title="ASoC Platform Driver">https://jackhuang021.github.io/archives/131a876a.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/ASoC/" rel="tag"># ASoC</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/archives/4896cd7d.html" rel="prev" title="Linux内核链表结构">
                  <i class="fa fa-chevron-left"></i> Linux内核链表结构
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/archives/d281c370.html" rel="next" title="Linux字符设备驱动开发">
                  Linux字符设备驱动开发 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:28</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/JackHuang021" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
